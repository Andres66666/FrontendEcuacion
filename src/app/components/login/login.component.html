<div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
  <div class="row w-100 justify-content-center g-0">
    <div class="col-12 col-md-10 col-lg-8 col-xl-7 d-flex align-items-center">
      <div class=" shadow w-100 p-4 rounded">
        
        <!-- LOGIN -->
        <div *ngIf="vistaActual === 'login'">
          <h2 class="text-center mb-4 fw-bold ">Iniciar Sesión</h2>
          <form (ngSubmit)="onSubmit(loginForm)" #loginForm="ngForm">
            <!-- CORREO -->
            <div class="mb-3">
              <label for="correo" class="form-label fw-semibold">Correo</label>
              <div class="input-group input-group-lg">
                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                <input id="correo" name="correo" class="form-control" [(ngModel)]="correo" type="email" required placeholder="ejemplo@correo.com" />
              </div>
            </div>

            <!-- PASSWORD -->
            <div class="mb-4">
              <label for="password" class="form-label fw-semibold">Contraseña</label>
              <div class="input-group input-group-lg">
                <input id="password" name="password" class="form-control" [(ngModel)]="password" [type]="showPassword ? 'text' : 'password'" required placeholder="********" />
                <button type="button" class="btn btn-light" (click)="togglePasswordVisibility()">
                  <i class="bi" [class.bi-eye]="!showPassword" [class.bi-eye-slash]="showPassword"></i>
                </button>
              </div>
            </div>

            <!-- BOTONES -->
            <div class="d-flex flex-column flex-md-row gap-2 justify-content-center">
              <button type="submit" class="btn btn-success flex-fill py-2" [disabled]="isLoading">
                <span *ngIf="!isLoading"><i class="bi bi-door-open me-2"></i>Login</span>
                <span *ngIf="isLoading"><i class="fas fa-spinner fa-pulse me-2"></i>Cargando...</span>
              </button>

              <button type="button" class="btn btn-info text-white flex-fill py-2" (click)="irAOlvide()">
                <i class="bi bi-question-circle me-2"></i>Olvidó la Contraseña
              </button>

              <button type="button" class="btn btn-secondary flex-fill py-2" (click)="navigateToHome()">
                <i class="bi bi-arrow-left-circle me-2"></i>Regresar
              </button>
            </div>
          </form>
        </div>

        <!-- OLVIDÉ -->
        <div *ngIf="vistaActual === 'olvide'">
          <h3 class="text-center mb-3 fw-bold"><i class="bi bi-shield-lock me-2"></i>Restablecer Contraseña</h3>
          <p class="text-center mb-4">Ingresa tu correo y te enviaremos una contraseña temporal.</p>
          <form (ngSubmit)="enviarCorreoReset()" #resetForm="ngForm">
            <div class="mb-3">
              <label for="correoReset" class="form-label fw-semibold">Correo Electrónico</label>
              <div class="input-group">
                <span class="input-group-text bg-white border"><i class="bi bi-envelope-fill text-secondary"></i></span>
                <input id="correoReset" name="correoReset" class="form-control" [(ngModel)]="correoReset" type="email" required placeholder="ejemplo@correo.com" />
              </div>
            </div>
            <div class="d-flex flex-column flex-md-row gap-2">
              <button type="submit" class="btn btn-primary flex-fill py-2" [disabled]="isLoading || !correoReset.trim()">
                <span *ngIf="!isLoading"><i class="bi bi-send-fill me-2"></i>Enviar</span>
                <span *ngIf="isLoading"><i class="fas fa-spinner fa-pulse me-2"></i>Enviando...</span>
              </button>
              <button type="button" class="btn btn-secondary flex-fill py-2" (click)="volverLogin()">
                <i class="bi bi-arrow-left-circle me-2"></i>Volver
              </button>
            </div>
          </form>
        </div>

        <!-- SELECCIÓN 2FA -->
        <div *ngIf="vistaActual === 'seleccion_2fa'">
          <h3 class="text-center mb-3 fw-bold "><i class="bi bi-shield-check me-2"></i>Verificación 2FA</h3>
          <p class="text-center mb-4 ">Elija el método para completar su autenticación.</p>
          <div class="d-flex flex-column flex-md-row gap-3 justify-content-center">
            <button class="btn btn-outline-light flex-fill py-3 shadow-sm d-flex flex-column align-items-center rounded-3" (click)="seleccionarMetodo('correo')" [disabled]="loading">
              <img src="https://img.icons8.com/?size=96&id=P7UIlhbpWzZm&format=png" alt="Correo" class="img-fluid mb-2" style="width:48px;height:48px;">
              <span class="fw-semibold">Correo</span>
            </button>
            <button class="btn btn-outline-light flex-fill py-3 shadow-sm d-flex flex-column align-items-center rounded-3" (click)="seleccionarMetodo('totp')" [disabled]="loading">
              <img src="https://img.icons8.com/?size=96&id=QvWnAvQBL2Gk&format=png" alt="Google Authenticator" class="img-fluid mb-2" style="width:48px;height:48px;">
              <span class="fw-semibold">Authenticator</span>
            </button>
          </div>
          <button type="button" class="btn btn-outline-secondary w-100 py-2 mt-3 rounded-3" (click)="volverLogin()">
            <i class="bi bi-arrow-left-circle me-2"></i>Cancelar
          </button>
        </div>

        <!-- 2FA -->
        <div *ngIf="vistaActual === '2fa'">
          <h2 class="text-center mb-4 fw-bold">Verificación por {{ metodoSeleccionado === 'correo' ? 'Correo' : 'App' }}</h2>

          <!-- Mensaje para correo -->
          <div *ngIf="metodoSeleccionado === 'correo'" class="alert alert-info mb-3 py-2">
            <p class="mb-0" *ngIf="codigoEnviado">Se ha enviado un código a su correo. Revise su bandeja de entrada.</p>
            <p class="mb-0" *ngIf="!codigoEnviado">Se enviará un código de verificación a su correo.</p>
          </div>

          <!-- Inputs y QR -->
          <!-- Método Correo -->
          <div *ngIf="metodoSeleccionado === 'correo'" class="d-flex justify-content-center mb-4">
            <div class="d-flex gap-2">
              <input #input0 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[0]"
                    (input)="onInputCode($event,0,input1)"
                    (keydown.backspace)="onBackspace($event,0,null)"
                    (paste)="onPaste($event,0)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:5rem;height:5rem;font-size:2rem;">
              <input #input1 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[1]"
                    (input)="onInputCode($event,1,input2)"
                    (keydown.backspace)="onBackspace($event,1,input0)"
                    (paste)="onPaste($event,1)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:5rem;height:5rem;font-size:2rem;">
              <input #input2 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[2]"
                    (input)="onInputCode($event,2,input3)"
                    (keydown.backspace)="onBackspace($event,2,input1)"
                    (paste)="onPaste($event,2)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:5rem;height:5rem;font-size:2rem;">
              <input #input3 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[3]"
                    (input)="onInputCode($event,3,input4)"
                    (keydown.backspace)="onBackspace($event,3,input2)"
                    (paste)="onPaste($event,3)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:5rem;height:5rem;font-size:2rem;">
              <input #input4 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[4]"
                    (input)="onInputCode($event,4,input5)"
                    (keydown.backspace)="onBackspace($event,4,input3)"
                    (paste)="onPaste($event,4)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:5rem;height:5rem;font-size:2rem;">
              <input #input5 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[5]"
                    (input)="onInputCode($event,5,null)"
                    (keydown.backspace)="onBackspace($event,5,input4)"
                    (paste)="onPaste($event,5)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:5rem;height:5rem;font-size:2rem;">
            </div>
          </div>


          <!-- Método App (Authenticator) -->
          <div *ngIf="metodoSeleccionado === 'totp'" class="row g-3 align-items-center mb-4">
            <div class="col-12 col-md-6 d-flex justify-content-center gap-2">
              <input #input0 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[0]"
                    (input)="onInputCode($event,0,input1)"
                    (keydown.backspace)="onBackspace($event,0,null)"
                    (paste)="onPaste($event,0)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:4rem;height:4rem;font-size:1.5rem;">
              <input #input1 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[1]"
                    (input)="onInputCode($event,1,input2)"
                    (keydown.backspace)="onBackspace($event,1,input0)"
                    (paste)="onPaste($event,1)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:4rem;height:4rem;font-size:1.5rem;">
              <input #input2 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[2]"
                    (input)="onInputCode($event,2,input3)"
                    (keydown.backspace)="onBackspace($event,2,input1)"
                    (paste)="onPaste($event,2)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:4rem;height:4rem;font-size:1.5rem;">
              <input #input3 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[3]"
                    (input)="onInputCode($event,3,input4)"
                    (keydown.backspace)="onBackspace($event,3,input2)"
                    (paste)="onPaste($event,3)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:4rem;height:4rem;font-size:1.5rem;">
              <input #input4 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[4]"
                    (input)="onInputCode($event,4,input5)"
                    (keydown.backspace)="onBackspace($event,4,input3)"
                    (paste)="onPaste($event,4)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:4rem;height:4rem;font-size:1.5rem;">
              <input #input5 type="text" maxlength="1" class="form-control text-center fw-bold"
                    [(ngModel)]="codigoInputs[5]"
                    (input)="onInputCode($event,5,null)"
                    (keydown.backspace)="onBackspace($event,5,input4)"
                    (paste)="onPaste($event,5)"
                    [disabled]="loading"
                    (keyup.enter)="codigo2FA.length === 6 && verificarCodigo()"
                    style="width:4rem;height:4rem;font-size:1.5rem;">
            </div>

            <div class="col-12 col-md-6 text-center">
              <p>Escanee este código QR con Google Authenticator:</p>
              <img [src]="qrBase64" class="img-fluid border rounded p-2" style="max-width:300px;">
              <p class="mt-2">Una vez escaneado, ingrese el código generado por la app.</p>
            </div>
          </div>

          <!-- Botones -->
          <div class="d-flex flex-column flex-md-row gap-2">
            <button class="btn btn-success flex-fill py-2" [disabled]="codigo2FA.length !== 6 || loading" (click)="verificarCodigo()">
              <span *ngIf="!loading">Verificar Código</span>
              <span *ngIf="loading"><i class="fas fa-spinner fa-pulse me-2"></i> Verificando...</span>
            </button>
            <button type="button" class="btn btn-secondary flex-fill py-2" (click)="volverLogin()">Cancelar</button>
          </div>
        </div>


        <!-- CAMBIAR PASSWORD TEMP -->
        <div *ngIf="vistaActual === 'cambiar_password_temp'">
          <div class="text-center mb-4">
            <h3 class="fw-bold"><i class="bi bi-shield-lock-fill me-2"></i>Restablecer</h3>
            <p>Revisa tu correo para la contraseña temporal.</p>
          </div>

          <div *ngIf="!tempVerificado" class="mb-3">
            <label for="tempPass" class="form-label fw-semibold">Contraseña Temporal</label>
            <div class="input-group">
              <input id="tempPass" name="tempPass" class="form-control" [(ngModel)]="tempPass" [type]="showPassword ? 'text' : 'password'" placeholder="Ingrese la contraseña temporal" required />
              <button type="button" class="btn btn-outline-secondary" (click)="togglePasswordVisibility()">
                <i class="bi" [class.bi-eye]="!showPassword" [class.bi-eye-slash]="showPassword"></i>
              </button>
            </div>
          </div>

          <div *ngIf="tempVerificado">
            <label for="nuevaPassword" class="form-label fw-semibold">Nueva Contraseña</label>
            <div class="input-group mb-3">
              <input id="nuevaPassword" name="nuevaPassword" class="form-control" [(ngModel)]="nuevaPassword" [type]="showPassword ? 'text' : 'password'" placeholder="Mínimo 8 caracteres" required />
              <button type="button" class="btn btn-outline-secondary" (click)="togglePasswordVisibility()">
                <i class="bi" [class.bi-eye]="!showPassword" [class.bi-eye-slash]="showPassword"></i>
              </button>
            </div>
            <label for="confirmarPassword" class="form-label fw-semibold">Confirmar Contraseña</label>
            <div class="input-group mb-3">
              <input id="confirmarPassword" name="confirmarPassword" class="form-control" [(ngModel)]="confirmarPassword" [type]="showPassword ? 'text' : 'password'" placeholder="Confirme su nueva contraseña" required />
              <button type="button" class="btn btn-outline-secondary" (click)="togglePasswordVisibility()">
                <i class="bi" [class.bi-eye]="!showPassword" [class.bi-eye-slash]="showPassword"></i>
              </button>
            </div>
          </div>

          <div class="d-flex flex-column flex-md-row gap-2">
            <button *ngIf="!tempVerificado" class="btn btn-primary flex-fill py-2" (click)="verificarTempPassword()" [disabled]="!tempPass.trim() || loading">
              <span *ngIf="!loading"><i class="bi bi-check-circle-fill me-2"></i> Verificar</span>
              <span *ngIf="loading"><i class="fas fa-spinner fa-pulse me-2"></i> Verificando...</span>
            </button>
            <button *ngIf="tempVerificado" class="btn btn-success flex-fill py-2" (click)="cambiarPasswordTemp()" [disabled]="!nuevaPassword || nuevaPassword !== confirmarPassword || loading">
              <span *ngIf="!loading"><i class="bi bi-unlock-fill me-2"></i> Cambiar</span>
              <span *ngIf="loading"><i class="fas fa-spinner fa-pulse me-2"></i> Actualizando...</span>
            </button>
            <button type="button" class="btn btn-secondary flex-fill py-2" (click)="volverLogin()"><i class="bi bi-arrow-left-circle me-2"></i> Volver</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Modales -->
<app-ok *ngIf="mensajeExito" [mensaje]="mensajeExito" (close)="manejarOk()"></app-ok>
<app-error *ngIf="mensajeError" [mensaje]="mensajeError" (close)="manejarError()"></app-error>
<app-advertencia *ngIf="mensajeAdvertencia" [mensaje]="mensajeAdvertencia" (close)="manejarAdvertencia()"></app-advertencia>
