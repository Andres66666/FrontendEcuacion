import { Component } from '@angular/core';

@Component({
  selector: 'app-proyecto',
  imports: [],
  templateUrl: './proyecto.html',
  styleUrl: './proyecto.css'
})
export class Proyecto {

}
export class ProyectoComponent implements OnInit {
  // Propiedades relacionadas con proyectos
  listaProyectos: Proyecto[] = [];
  proyectoSeleccionado: Proyecto | null = null;
  proyectoData: Partial<Proyecto> = {};
  nombreProyecto: string = '';
  carga_social: number = 0;
  iva_efectiva: number = 0;
  herramientas: number = 0;
  gastos_generales: number = 0;
  iva_tasa_nominal: number = 0;
  it: number = 0;
  iue: number = 0;
  ganancia: number = 0;
  a_costo_venta: number = 0;
  b_margen_utilidad: number = 0;
  porcentaje_global_100: number = 100;
  usuario_id = 0;
  nombre_usuario = '';
  apellido = '';
  roles: string[] = [];
  permisos: string[] = [];
  proyectosFiltrados: Proyecto[] = [];
  mostrarConfirmacion = false;
  tipoConfirmacion: 'proyecto' | null = null;
  mensajeConfirmacion = '';
  mensajeExito = '';
  mensajeError = '';
  modalNuevoProyecto: any;
  modalParametros: any;
  mostrarDropdownProyectos: boolean = false;
  identificadorGeneral = 0;

  // Output para comunicar con el componente padre
  @Output() proyectoSeleccionadoChange = new EventEmitter<Proyecto | null>();
  @Output() listaProyectosChange = new EventEmitter<Proyecto[]>();

  constructor(private servicios: ServiciosService) {}

  ngOnInit(): void {
    this.recuperarUsuarioLocalStorage();
    this.cargarProyectos();

    // Inicializar modales
    const modalNuevoEl = document.getElementById('modalNuevoProyecto');
    this.modalNuevoProyecto = modalNuevoEl
      ? new bootstrap.Modal(modalNuevoEl)
      : null;

    const modalProyectoParametrosEl = document.getElementById(
      'modalProyectoParametros'
    );
    this.modalParametros = modalProyectoParametrosEl
      ? new bootstrap.Modal(modalProyectoParametrosEl)
      : null;
  }

  private recuperarUsuarioLocalStorage() {
    const usuarioStr = localStorage.getItem('usuarioLogueado');
    if (!usuarioStr) return;

    try {
      const datosUsuario = JSON.parse(usuarioStr);
      this.usuario_id = datosUsuario.id ?? 0;
      this.nombre_usuario = datosUsuario.nombre ?? '';
      this.apellido = datosUsuario.apellido ?? '';
      this.roles = datosUsuario.rol ?? [];
      this.permisos = datosUsuario.permiso ?? [];
    } catch (error) {
      console.error('Error al parsear usuario desde localStorage', error);
    }
  }

  cargarProyectos(): void {
    this.servicios.getIdentificadorGeneral().subscribe({
      next: (res) => {
        this.listaProyectos = res;
        this.filtrarProyectos();
        this.listaProyectosChange.emit(this.listaProyectos);
      },
      error: (err) =>
        this.mostrarMensaje(
          'error',
          'No se pudieron cargar los proyectos existentes.'
        ),
    });
  }

  private asignarProyecto(proyecto: Proyecto | null) {
    if (!proyecto) {
      this.resetearProyecto();
      return;
    }

    this.proyectoSeleccionado = proyecto;
    this.proyectoData = { ...proyecto };
    this.identificadorGeneral = proyecto.id_general;
    this.nombreProyecto = proyecto.NombreProyecto;

    // Asignar par√°metros del proyecto
    this.asignarParametrosProyecto(proyecto);

    this.proyectoSeleccionadoChange.emit(proyecto);
  }

  private asignarParametrosProyecto(proyecto: Proyecto): void {
    this.proyectoData = { ...proyecto };
    this.carga_social = proyecto.carga_social ?? 0;
    this.iva_efectiva = proyecto.iva_efectiva ?? 0;
    this.herramientas = proyecto.herramientas ?? 0;
    this.gastos_generales = proyecto.gastos_generales ?? 0;
    this.iva_tasa_nominal = proyecto.iva_tasa_nominal ?? 0;
    this.it = proyecto.it ?? 0;
    this.iue = proyecto.iue ?? 0;
    this.ganancia = proyecto.ganancia ?? 0;
    this.a_costo_venta = proyecto.a_costo_venta ?? 0;
    this.b_margen_utilidad = proyecto.b_margen_utilidad ?? 0;
    this.porcentaje_global_100 = proyecto.porcentaje_global_100 ?? 100;
  }

  onProyectoSeleccionado(): void {
    const proyecto = this.listaProyectos.find(
      (p) =>
        p.NombreProyecto.toLowerCase() ===
        (this.proyectoData.NombreProyecto ?? '').toLowerCase()
    );
    this.asignarProyecto(proyecto || null);
  }

  crearIdentificadorSiEsNecesario(): void {
    if (this.identificadorGeneral !== 0) {
      // Aqu√≠ podr√≠as emitir un evento para agregar item en el componente padre
      return;
    }

    if (!this.validarProyectoCompleto()) return;

    this.mensajeConfirmacion = '¬øDeseas registrar el proyecto?';
    this.tipoConfirmacion = 'proyecto';
    this.mostrarConfirmacion = true;
  }

  guardarProyecto() {
    if (!this.nombreProyecto.trim()) {
      this.mostrarModalError('Ingrese un nombre v√°lido para el proyecto');
      return;
    }

    const proyectoPayload: Partial<Proyecto> = {
      NombreProyecto: this.nombreProyecto.trim(),
      carga_social: this.toNum(this.carga_social),
      iva_efectiva: this.toNum(this.iva_efectiva),
      herramientas: this.toNum(this.herramientas),
      gastos_generales: this.toNum(this.gastos_generales),
      iva_tasa_nominal: this.toNum(this.iva_tasa_nominal),
      it: this.toNum(this.it),
      iue: this.toNum(this.iue),
      ganancia: this.toNum(this.ganancia),
      a_costo_venta: this.toNum(this.a_costo_venta),
      b_margen_utilidad: this.toNum(this.b_margen_utilidad),
      porcentaje_global_100: this.toNum(this.porcentaje_global_100),
      creado_por: this.usuario_id,
      modificado_por: this.usuario_id,
    };

    const observable = this.proyectoSeleccionado?.id_general
      ? this.servicios.updateIdentificadorGeneral({
          ...proyectoPayload,
          id_general: this.proyectoSeleccionado.id_general,
        } as Proyecto)
      : this.servicios.createIdentificadorGeneral(proyectoPayload);

    observable.subscribe({
      next: (resp) => {
        this.asignarProyecto(resp);

        // Volver a cargar desde backend para tener lista REAL
        this.servicios.getIdentificadorGeneral().subscribe({
          next: (proyectos) => {
            this.listaProyectos = proyectos;
            this.filtrarProyectos();
            this.listaProyectosChange.emit(this.listaProyectos);
          },
        });

        this.mostrarModalExito(
          this.proyectoSeleccionado?.id_general
            ? 'Proyecto actualizado'
            : 'Proyecto creado'
        );
      },
      error: (err) =>
        this.mostrarModalError(
          'Error al guardar proyecto: ' +
            (err.error?.error || 'Intente de nuevo')
        ),
    });
  }

  registrarProyecto(): void {
    this.guardarProyecto();
  }

  registrarNuevoProyecto(): void {
    this.guardarProyecto();
  }

  guardarParametros(): void {
    if (!this.proyectoSeleccionado) {
      this.mostrarModalError('No hay proyecto seleccionado');
      return;
    }

    const proyectoPayload: Partial<Proyecto> = {
      id_general: this.proyectoSeleccionado.id_general,
      NombreProyecto: this.nombreProyecto.trim(),
      carga_social: this.toNum(this.carga_social),
      iva_efectiva: this.toNum(this.iva_efectiva),
      herramientas: this.toNum(this.herramientas),
      gastos_generales: this.toNum(this.gastos_generales),
      iva_tasa_nominal: this.toNum(this.iva_tasa_nominal),
      it: this.toNum(this.it),
      iue: this.toNum(this.iue),
      ganancia: this.toNum(this.ganancia),
      a_costo_venta: this.toNum(this.a_costo_venta),
      b_margen_utilidad: this.toNum(this.b_margen_utilidad),
      porcentaje_global_100: this.toNum(this.porcentaje_global_100),
      modificado_por: this.usuario_id,
    };

    this.servicios
      .updateIdentificadorGeneral(proyectoPayload as Proyecto)
      .subscribe({
        next: (resp) => {
          // Actualizar estado local y lista
          const proyectoActualizado = {
            ...this.proyectoSeleccionado,
            ...proyectoPayload,
          } as Proyecto;

          // Actualizar proyecto seleccionado
          this.asignarProyecto(proyectoActualizado);

          // Actualizar en la lista de proyectos
          this.listaProyectos = this.listaProyectos.map((p) =>
            p.id_general === proyectoActualizado.id_general
              ? proyectoActualizado
              : p
          );

          // Cerrar modal
          const modalEl = document.getElementById('modalProyectoParametros');
          if (modalEl) {
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
          }

          // Mostrar mensaje de √©xito
          this.mostrarModalExito('Par√°metros actualizados correctamente');
        },
        error: (err) => {
          this.mostrarModalError(
            'Error al actualizar par√°metros: ' +
              (err.error?.error || 'Intente de nuevo')
          );
        },
      });
    this.cerrarModalParametros();
  }

  actualizarProyecto(): void {
    this.guardarProyecto();
  }

  duplicarProyecto(proyecto: Proyecto, event: Event): void {
    event.stopPropagation();

    const proyectoDuplicado: Partial<Proyecto> = {
      ...proyecto,
      id_general: 0,
      NombreProyecto: proyecto.NombreProyecto + ' (Copia)',
      creado_por: this.usuario_id,
      modificado_por: this.usuario_id,
    };

    this.servicios.createIdentificadorGeneral(proyectoDuplicado).subscribe({
      next: (nuevoProyecto: Proyecto) => {
        this.servicios.getModulosPorProyecto(proyecto.id_general).subscribe({
          next: (modulosOriginales) => {
            // Crear m√≥dulos uno a uno y esperar todos
            const observables = modulosOriginales.map((mod) => {
              const nuevoModulo: Partial<Modulo> = {
                ...mod,
                id: 0,
                proyecto: nuevoProyecto.id_general,
                creado_por: this.usuario_id,
                modificado_por: this.usuario_id,
              };
              return this.servicios.createModulo(nuevoModulo);
            });

            forkJoin(observables).subscribe({
              next: (modulosGuardados) => {
                // Mapa id original -> id duplicado
                const mapaModulos = new Map<number, number>();
                modulosOriginales.forEach((modOriginal, idx) => {
                  mapaModulos.set(modOriginal.id!, modulosGuardados[idx].id!);
                });

                this.servicios
                  .getGastoOperacionID(proyecto.id_general)
                  .subscribe({
                    next: (gastosOriginales) => {
                      // Mapear gastos originales a duplicados, usando modulo_id
                      const gastosDuplicados: (Partial<GastoOperacion> & {
                        modulo_id?: number | null;
                      })[] = gastosOriginales.map((g) => ({
                        ...g,
                        id: 0,
                        identificador: nuevoProyecto,
                        modulo_id: g.modulo
                          ? mapaModulos.get(g.modulo.id!) ?? null
                          : null,
                        creado_por: this.usuario_id,
                        modificado_por: this.usuario_id,
                      }));

                      // Eliminar la propiedad 'modulo' para evitar conflicto
                      gastosDuplicados.forEach((g) => delete (g as any).modulo);

                      this.servicios
                        .createGastoOperacion(gastosDuplicados)
                        .subscribe({
                          next: (gastosGuardados: any) => {
                            gastosGuardados.gastos.forEach(
                              (
                                gastoDuplicado: GastoOperacion,
                                index: number
                              ) => {
                                const original = gastosOriginales[index];
                                this.duplicarSubItems(
                                  original.id,
                                  gastoDuplicado.id
                                );
                              }
                            );

                            this.mostrarModalExito(
                              'Proyecto duplicado correctamente con m√≥dulos y gastos.'
                            );
                            this.filtrarProyectos();
                          },
                          error: (err: any) =>
                            this.mostrarModalError(
                              'Error al duplicar gastos: ' +
                                (err.error?.error || 'Intente de nuevo')
                            ),
                        });
                    },
                    error: (err: any) =>
                      this.mostrarModalError(
                        'Error al obtener gastos originales: ' +
                          (err.error?.error || 'Intente de nuevo')
                      ),
                  });
              },
              error: (err: any) =>
                this.mostrarModalError(
                  'Error al duplicar m√≥dulos: ' +
                    (err.error?.error || 'Intente de nuevo')
                ),
            });
          },
          error: (err: any) =>
            this.mostrarModalError(
              'Error al obtener m√≥dulos originales: ' +
                (err.error?.error || 'Intente de nuevo')
            ),
        });
      },
      error: (err: any) =>
        this.mostrarModalError(
          'Error al duplicar proyecto: ' +
            (err.error?.error || 'Intente de nuevo')
        ),
    });
  }

  duplicarSubItems(idGastoOriginal: number, idGastoDuplicado: number) {
    // Materiales
    this.servicios
      .getMaterialesIDGasto(idGastoOriginal)
      .subscribe((materiales) => {
        const nuevos = materiales.map((m) => ({
          ...m,
          id: 0,
          id_gasto_operacion: idGastoDuplicado,
          creado_por: this.usuario_id,
        }));
        this.servicios.createMateriales(nuevos).subscribe();
      });

    // Mano de obra
    this.servicios.getManoDeObraIDGasto(idGastoOriginal).subscribe((manos) => {
      const nuevas = manos.map((m) => ({
        ...m,
        id: 0,
        id_gasto_operacion: idGastoDuplicado,
        creado_por: this.usuario_id,
      }));
      this.servicios.createManoDeObraLista(nuevas).subscribe();
    });

    // Equipo/Herramienta
    this.servicios
      .getEquipoHerramientas(idGastoOriginal)
      .subscribe((equipos) => {
        const nuevos = equipos.map((e) => ({
          ...e,
          id: 0,
          id_gasto_operacion: idGastoDuplicado,
          creado_por: this.usuario_id,
        }));
        this.servicios.createEquipoHerramientaLista(nuevos).subscribe();
      });

    // Gastos Generales
    this.servicios
      .getGastosGenerales(idGastoOriginal)
      .subscribe((gastosGen) => {
        const nuevos = gastosGen.map((g) => ({
          ...g,
          id: 0,
          id_gasto_operacion: idGastoDuplicado,
          creado_por: this.usuario_id,
        }));
        this.servicios.createGastosGeneralesLista(nuevos).subscribe();
      });
  }

  abrirModalParametros(verProyectoExistente: boolean) {
    if (verProyectoExistente && this.proyectoSeleccionado) {
      // Editar proyecto existente
      this.nombreProyecto = this.proyectoSeleccionado.NombreProyecto;
      this.carga_social = this.proyectoSeleccionado.carga_social ?? 0;
      this.iva_efectiva = this.proyectoSeleccionado.iva_efectiva ?? 0;
      this.herramientas = this.proyectoSeleccionado.herramientas ?? 0;
      this.gastos_generales = this.proyectoSeleccionado.gastos_generales ?? 0;
      this.iva_tasa_nominal = this.proyectoSeleccionado.iva_tasa_nominal ?? 0;
      this.it = this.proyectoSeleccionado.it ?? 0;
      this.iue = this.proyectoSeleccionado.iue ?? 0;
      this.ganancia = this.proyectoSeleccionado.ganancia ?? 0;
      this.a_costo_venta = this.proyectoSeleccionado.a_costo_venta ?? 0;
      this.b_margen_utilidad = this.proyectoSeleccionado.b_margen_utilidad ?? 0;
      this.porcentaje_global_100 =
        this.proyectoSeleccionado.porcentaje_global_100 ?? 100;
    } else {
      // Crear nuevo proyecto ‚Üí limpiar campos
      this.proyectoSeleccionado = null;
      this.nombreProyecto = '';
      this.carga_social = 0;
      this.iva_efectiva = 0;
      this.herramientas = 0;
      this.gastos_generales = 0;
      this.iva_tasa_nominal = 0;
      this.it = 0;
      this.iue = 0;
      this.ganancia = 0;
      this.a_costo_venta = 0;
      this.b_margen_utilidad = 0;
      this.porcentaje_global_100 = 100;
    }

    const modalEl = document.getElementById('modalProyectoParametros');
    if (modalEl) {
      const modalInst =
        bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modalInst.show();
    } else {
      // Fallback: mostrar mensaje m√≠nimo sin lanzar error
      this.mostrarMensaje('error', 'No se encontr√≥ el modal de par√°metros.');
    }
  }

  cerrarModalParametros() {
    const modalEl = document.getElementById('modalProyectoParametros');
    if (!modalEl) return;

    // ‚ùå Quitar foco de cualquier bot√≥n dentro del modal
    const btnFoco = modalEl.querySelector('button:focus') as HTMLElement;
    if (btnFoco) btnFoco.blur();

    // ‚úÖ Usar Bootstrap para cerrar modal correctamente
    const modalInst = bootstrap.Modal.getInstance(modalEl);
    if (modalInst) {
      modalInst.hide();
    }
  }

  filtrarProyectos(): void {
    const termino = this.nombreProyecto.toLowerCase().trim();
    this.proyectosFiltrados = termino
      ? this.listaProyectos.filter((p) =>
          p.NombreProyecto.toLowerCase().includes(termino)
        )
      : [...this.listaProyectos]; // si input vac√≠o ‚Üí mostrar todos
  }

  seleccionarProyecto(proyecto: Proyecto): void {
    this.nombreProyecto = proyecto.NombreProyecto; // Esto mantiene el nombre en el input
    this.asignarProyecto(proyecto);
    this.mostrarDropdownProyectos = false; // CORREGIDO: Usa nueva propiedad (cierra dropdown)
  }

  focusInput() {
    this.proyectosFiltrados = [...this.listaProyectos];
    this.mostrarDropdownProyectos = true;
  }

  eliminarProyecto(): void {
    if (!this.identificadorGeneral) {
      this.mostrarModalError('Selecciona un proyecto para eliminar.');
      return;
    }
    this.mensajeConfirmacion =
      '¬øSeguro que deseas eliminar este proyecto y todos sus registros asociados?';
    this.tipoConfirmacion = 'proyecto';
    this.mostrarConfirmacion = true;
  }

  /* Bloque 5: UI, Modales y Mensajes */
  private mostrarMensaje(
    tipo: 'exito' | 'error',
    mensaje: string,
    duracion = 20000
  ) {
    if (tipo === 'exito') this.mensajeExito = mensaje;
    else this.mensajeError = mensaje;

    setTimeout(() => {
      if (tipo === 'exito') this.mensajeExito = '';
      else this.mensajeError = '';
    }, duracion);
  }

  private mostrarModalExito(mensaje: string, duracion = 2000) {
    this.mensajeExito = mensaje;
    setTimeout(() => (this.mensajeExito = ''), duracion);
  }

  private mostrarModalError(mensaje: string, duracion = 2000) {
    this.mensajeError = mensaje;
    const modalEl = document.getElementById('modalError');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    setTimeout(() => modal.hide(), duracion);
  }

  confirmarEliminacion(): void {
    // Para proyectos, manejar eliminaci√≥n aqu√≠
    if (this.tipoConfirmacion === 'proyecto') {
      this.servicios
        .deleteIdentificadorGeneral(this.identificadorGeneral)
        .subscribe({
          next: () => {
            // üîπ Recargar lista REAL desde el backend
            this.servicios.getIdentificadorGeneral().subscribe({
              next: (proyectos) => {
                this.listaProyectos = proyectos;
                this.filtrarProyectos();
                this.listaProyectosChange.emit(this.listaProyectos);
              },
              error: () =>
                this.mostrarMensaje('error', 'Error al recargar proyectos.'),
            });

            this.asignarProyecto(null); // limpiar selecci√≥n
            this.mostrarMensaje('exito', 'Proyecto eliminado correctamente.');
          },
          error: () =>
            this.mostrarMensaje('error', 'Error al eliminar el proyecto.'),
        });
    }

    // Reset modal
    this.mostrarConfirmacion = false;
    this.tipoConfirmacion = null;
  }

  manejarAceptar() {
    this.confirmarEliminacion();
  }

  manejarCancelar() {
    this.mostrarConfirmacion = false;
    this.tipoConfirmacion = null;
  }

  manejarOk() {
    this.mensajeExito = '';
  }

  manejarError() {
    this.mensajeError = '';
  }

  private validarProyectoCompleto(): boolean {
    for (const key in this.proyectoData) {
      if (
        this.proyectoData[key as keyof Proyecto] === null ||
        this.proyectoData[key as keyof Proyecto] === ''
      ) {
        this.mostrarMensaje('error', 'Completa todos los campos');
        return false;
      }
    }
    return true;
  }

  private resetearProyecto(): void {
    this.proyectoSeleccionado = null;
    this.proyectoData = {};
    this.identificadorGeneral = 0;
    this.nombreProyecto = '';
    this.carga_social = 0;
    this.iva_efectiva = 0;
    this.herramientas = 0;
    this.gastos_generales = 0;
    this.iva_tasa_nominal = 0;
    this.it = 0;
    this.iue = 0;
    this.ganancia = 0;
    this.a_costo_venta = 0;
    this.b_margen_utilidad = 0;
    this.porcentaje_global_100 = 100;
  }

  /* Bloque 9: Utilidades y Validaciones */
  toNum(valor: any): number {
    return Number(valor) || 0;
  }

  // M√©todo para filtrar el campo "Nombre del Proyecto" (solo letras, n√∫meros, espacios y acentos; sin caracteres especiales)
  filtrarNombreProyectoInput(event: Event): void {
    const input = event.target as HTMLInputElement;
    let valor = input.value;
    valor = valor.replace(/[^a-zA-Z0-9√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]/g, '');
    valor = valor.replace(/\s{2,}/g, ' ');
    input.value = valor;
    this.nombreProyecto = valor;
  }
}




<div>
  <div
    class="modal fade"
    id="modalProyectoParametros"
    tabindex="-1"
    aria-labelledby="modalProyectoParametrosLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalProyectoParametrosLabel">
            {{
              proyectoSeleccionado
                ? "Par√°metros del Proyecto"
                : "Crear Nuevo Proyecto"
            }}
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>

        <div class="modal-body">
          <!-- Nombre del Proyecto -->
          <div class="mb-3">
            <label class="form-label">Nombre del Proyecto</label>
            <input
              type="text"
              class="form-control"
              [(ngModel)]="nombreProyecto"
              (input)="filtrarNombreProyectoInput($event)"
              placeholder="Ingrese nombre del proyecto"
            />
          </div>

          <!-- Tabla de Par√°metros -->
          <table class="table table-bordered">
            <thead>
              <tr>
                <th class="text-center">PAR√ÅMETROS</th>
                <th class="text-center">EN PORCENTAJE (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>CARGAS SOCIALES</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="carga_social"
                  />
                </td>
              </tr>
              <tr>
                <td>IVA TASA EFECTIVA</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="iva_efectiva"
                  />
                </td>
              </tr>
              <tr>
                <td>HERRAMIENTAS</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="herramientas"
                  />
                </td>
              </tr>
              <tr>
                <td>GASTOS GENERALES</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="gastos_generales"
                  />
                </td>
              </tr>
              <tr>
                <td>IVA TASA NOMINAL</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="iva_tasa_nominal"
                  />
                </td>
              </tr>
              <tr>
                <td>IT TASA NOMINAL</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="it"
                  />
                </td>
              </tr>
              <tr>
                <td>IUE</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="iue"
                  />
                </td>
              </tr>
              <tr>
                <td>GANANCIA</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="ganancia"
                  />
                </td>
              </tr>
              <tr>
                <td>A - COSTO DE VENTA</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="a_costo_venta"
                  />
                </td>
              </tr>
              <tr>
                <td>B - MARGEN DE UTILIDAD</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="b_margen_utilidad"
                  />
                </td>
              </tr>
              <tr>
                <td>PORCENTAJE GLOBAL</td>
                <td>
                  <input
                    type="number"
                    class="form-control text-center"
                    [(ngModel)]="porcentaje_global_100"
                    disabled
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cerrarModalParametros()"
          >
            Cancelar
          </button>

          <button
            type="button"
            class="btn btn-primary"
            (click)="
              proyectoSeleccionado
                ? guardarParametros()
                : registrarNuevoProyecto()
            "
          >
            {{
              proyectoSeleccionado ? "Guardar Cambios" : "Crear Proyecto"
            }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- üìå Secci√≥n de Selecci√≥n Proyecto + Botones -->
  <div
    class="col-12 d-flex flex-row flex-wrap align-items-center justify-content-start gap-3 mb-3"
  >
    <div
      class="position-relative flex-grow-1 proyecto-dropdown"
      style="min-width: 200px"
    >
      <input
        class="form-control text-center"
        placeholder="Nombre del Proyecto"
        [(ngModel)]="nombreProyecto"
        (focus)="focusInput()"
        (input)="filtrarProyectos()"
        readonly
      />
      <ul
        *ngIf="mostrarDropdownProyectos"
        class="list-group position-absolute text-start"
        style="
          z-index: 1050;
          max-height: 200px;
          overflow-y: auto;
          width: 100%;
          background: white;
          border: 1px solid #ccc;
          border-radius: 0 0 4px 4px;
        "
      >
        <li
          class="list-group-item d-flex justify-content-between align-items-center p-2"
          *ngFor="let proyecto of proyectosFiltrados"
        >
          <span
            (click)="
              seleccionarProyecto(proyecto); $event.stopPropagation()
            "
            style="cursor: pointer; flex-grow: 1"
            class="text-decoration-none"
          >
            {{ proyecto.NombreProyecto }}
          </span>

          <button
            class="btn btn-sm btn-primary ms-2"
            type="button"
            (click)="
              duplicarProyecto(proyecto, $event); $event.stopPropagation()
            "
            title="Duplicar proyecto"
          >
            <img
              src="https://cdn-icons-png.flaticon.com/128/3384/3384831.png"
              class="img-fluid"
              style="width: 20px; height: 20px"
              alt="Duplicar"
            />
            Duplicar
          </button>
        </li>
      </ul>
    </div>

    <!-- Botones -->
    <button
      class="btn d-flex flex-column align-items-center"
      title="Ver Par√°metros"
      [disabled]="!proyectoSeleccionado"
      (click)="abrirModalParametros(true)"
    >
      <img
        src="https://cdn-icons-png.flaticon.com/128/9390/9390678.png"
        class="img-fluid"
        style="width: 40px; height: 40px"
      />
      <small>Ver Par√°metros</small>
    </button>

    <button
      class="btn d-flex flex-column align-items-center"
      title="Crear Nuevo Proyecto"
      (click)="abrirModalParametros(false)"
    >
      <img
        src="https://cdn-icons-png.flaticon.com/128/11750/11750438.png"
        class="img-fluid"
        style="width: 40px; height: 40px"
      />
      <small>Nuevo Proyecto</small>
    </button>

    <button
      class="btn d-flex flex-column align-items-center"
      *ngIf="identificadorGeneral === 0"
      (click)="crearIdentificadorSiEsNecesario()"
      title="Registrar Proyecto"
    >
      <img
        src="https://cdn-icons-png.flaticon.com/128/17087/17087969.png"
        class="img-fluid"
        style="width: 40px; height: 40px"
      />
      <small>Registrar Proyecto</small>
    </button>

    <button
      class="btn d-flex flex-column align-items-center"
      *ngIf="identificadorGeneral !== 0"
      (click)="eliminarProyecto()"
      title="Eliminar Proyecto"
    >
      <img
        src="https://cdn-icons-png.flaticon.com/128/6861/6861362.png"
        class="img-fluid"
        style="width: 40px; height: 40px"
      />
      <small>Eliminar Proyecto</small>
    </button>

    <button
      class="btn d-flex flex-column align-items-center"
      *ngIf="identificadorGeneral !== 0"
      (click)="actualizarProyecto()"
      title="Actualizar Proyecto"
    >
      <img
        src="https://cdn-icons-png.flaticon.com/128/1601/1601884.png"
        class="img-fluid"
        style="width: 40px; height: 40px"
      />
      <small>Actualizar Proyecto</small>
    </button>
  </div>

  <!-- Componentes de Mensajes -->
   <app-confirmacion 
    *ngIf="mostrarConfirmacionEliminar"
    [mensaje]="mensajeConfirmacionEliminar"
    (aceptar)="confirmarEliminarProyecto()"
    (cancelar)="cancelarEliminarProyecto()">
    
   </app-confirmacion>
  <app-confirmacion
    *ngIf="mostrarConfirmacion"
    [mensaje]="mensajeConfirmacion"
    (aceptar)="manejarAceptar()"
    (cancelar)="manejarCancelar()"
  ></app-confirmacion>
  <app-ok
    *ngIf="mensajeExito"
    [mensaje]="mensajeExito"
    (close)="manejarOk()"
  ></app-ok>

  <app-error
    *ngIf="mensajeError"
    [mensaje]="mensajeError"
    (close)="manejarError()"
  ></app-error>
</div>