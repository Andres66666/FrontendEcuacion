
  <div id="contentToExport">
    <h2 class="mb-4 text-primary text-center text-uppercase" >
      PRESUPUESTO POR ACTIVIDAD Y GENERAL DEL PROYECTO
    </h2>
    <!-- Formulario de porcentajes -->
    <div class="rounded shadow-sm">
      <div class="row">
        <!-- 游늷 Columna Izquierda: Tabla de Par치metros -->
        <div class="col-md-6 no-export">
          <button 
            class="btn btn-outline-primary mb-2 w-100"
            (click)="mostrarParametros = !mostrarParametros"
          >
            {{ mostrarParametros ? 'Ocultar Par치metros' : 'Mostrar Par치metros' }}
          </button>

          <div *ngIf="mostrarParametros" class="no-export">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th scope="col" class="text-center">PAR츼METROS</th>
                  <th scope="col" class="text-center">EN PORCENTAJE (%)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="align-middle">CARGAS SOCIALES</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="carga_social" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IVA TASA EFECTIVA</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="iva_efectiva" /></td>
                </tr>
                <tr>
                  <td class="align-middle">HERRAMIENTAS</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="herramientas" /></td>
                </tr>
                <tr>
                  <td class="align-middle">GASTOS GENERALES</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="gastos_generales" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IVA TASA NOMINAL</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="iva_tasa_nominal" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IT TASA NOMINAL</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="it" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IUE - IMPUESTO A LAS UTILIDADES DE LAS EMPRESAS</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="iue" /></td>
                </tr>
                <tr>
                  <td class="align-middle">GANANCIA</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="ganancia" /></td>
                </tr>
                <tr>
                  <td class="align-middle">A - COSTO DE VENTA</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="a_costo_venta" /></td>
                </tr>
                <tr>
                  <td class="align-middle">B - MARGEN DE UTILIDAD</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="b_margen_utilidad" /></td>
                </tr>
                <tr>
                  <td class="align-middle">PORCENTAJE GLOBAL</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="porcentaje_global_100" disabled /></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- 游늷 Columna Derecha: Selecci칩n Proyecto + Botones -->
        <div class="col-md-6 d-flex flex-column justify-content-end mb-3">
          <div class="mb-3 text-center no-export" style="position: relative;">
            <input
              class="form-control text-center"
              placeholder="Nombre del Proyecto"
              [(ngModel)]="nombreProyecto"
              (focus)="focusInput()"
              (input)="filtrarProyectos()"
            />

            <!-- Dropdown simulado con ancho reducido -->
            <ul
              *ngIf="mostrarLista"
              class="list-group position-absolute text-start"
              style="z-index: 1000; max-height: 200px; overflow-y: auto; width: 50%; left: 0;"
            >
              <li
                class="list-group-item list-group-item-action"
                *ngFor="let proyecto of proyectosFiltrados"
                (click)="seleccionarProyecto(proyecto)"
              >
                {{ proyecto.NombreProyecto }}
              </li>
            </ul>
          </div>

          <div class="d-flex flex-wrap gap-3 justify-content-end no-export">
            <!-- Nuevo Proyecto -->
            <button
              class="btn d-flex flex-column align-items-center"
              (click)="nuevoProyecto()"
              title="Crear Nuevo Proyecto"
            >
              <img 
                src="https://cdn-icons-png.flaticon.com/128/11750/11750438.png" 
                class="img-fluid"
                style="width: 40px; height: 40px;"
              />  
              <small>Nuevo</small>
            </button>

            <!-- Registrar Proyecto -->
            <button
              class="btn d-flex flex-column align-items-center"
              *ngIf="identificadorGeneral === 0"
              (click)="crearIdentificadorSiEsNecesario()"
              title="Registrar Proyecto"
            >
              <img 
                src="https://cdn-icons-png.flaticon.com/128/17087/17087969.png" 
                class="img-fluid"
                style="width: 40px; height: 40px;"
              />
              <small>Registrar Proyecto</small>
            </button>

            <!-- Eliminar Proyecto -->
            <button
              class="btn d-flex flex-column align-items-center"
              *ngIf="identificadorGeneral !== 0"
              (click)="eliminarProyecto()"
              title="Eliminar Proyecto"
            >
              <img 
                src="https://cdn-icons-png.flaticon.com/128/11629/11629955.png" 
                class="img-fluid"
                style="width: 40px; height: 40px;"
              />   
              <small>Eliminar Proyecto</small>
            </button>

            <!-- Actualizar Proyecto -->
            <button
              class="btn d-flex flex-column align-items-center"
              *ngIf="identificadorGeneral !== 0"
              (click)="actualizarProyecto()"
              title="Actualizar Proyecto"
            >
              <img 
                src="https://cdn-icons-png.flaticon.com/128/12388/12388400.png" 
                class="img-fluid"
                style="width: 40px; height: 40px;"
              />   
              <small>Actualizar Proyecto</small>
            </button>

            <!-- Agregar 칈tem -->
            <button
              class="btn d-flex flex-column align-items-center"
              [disabled]="identificadorGeneral === 0"
              (click)="agregarItem()"
              title="Agregar 칈tem Gastos Operaci칩n"
            >
            <img 
              src="https://cdn-icons-png.flaticon.com/128/1493/1493661.png" 
              class="img-fluid"
              style="width: 40px; height: 40px;"
            />              
              <small>Agregar 칈tem</small>
            </button>
            <!-- Exportar PDF -->
            <button
              class="btn d-flex flex-column align-items-center"
              (click)="exportPDF()"
              title="Exportar a PDF"
            >
              <img 
                src="https://cdn-icons-png.flaticon.com/128/6968/6968842.png" 
                class="img-fluid"
                style="width: 40px; height: 40px;"
              />
              <small>Descargar PDF</small>
            </button>

            <!-- Exportar Word -->
            <button
              class="btn d-flex flex-column align-items-center"
              (click)="exportWORD()"
              title="Exportar a Word"
            >
              <img 
                src="https://cdn-icons-png.flaticon.com/128/888/888883.png" 
                class="img-fluid"
                style="width: 40px; height: 40px;"
              />
              <small>Descargar Word</small>
            </button>
          </div>


        </div>
      </div>
    </div>

    <!-- Tabla de Gastos de Operaci칩n -->
    <div
      class="table-responsive border rounded shadow-sm"
      style="max-height: 500px; overflow-y: auto"
    >
      <table class="table table-bordered table-hover align-middle text-center mb-0">
        <thead class="table-primary">
          <tr>
            <th>Item</th>
            <th>Descripci칩n</th>
            <th>Unidad.</th>
            <th>Cantidad</th>
            <th>Gastos De Operacion</th>
            <th>Valor Agregado</th>
            <th>Precio Unitario Actividad</th>
            <th>Precio Unitario Literal</th>
            <th>Precio Factura Parcial</th>
            <th class="no-export">Acciones</th> <!-- 游녣 no se exporta -->
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let item of items; let i = index">
            <td>{{ i + 1 }}</td>
            <td class="input-cell">
              <input
                [(ngModel)]="item.descripcion"
                class="full-width-input"
                placeholder="Descripci칩n"
              />
            </td>
            <!-- Unidad -->
            <td>
              <ng-container *ngIf="item.esNuevo || item.editarUnidad; else verUnidad">
                <select
                  class="form-select"
                  [(ngModel)]="item.unidad"
                  (blur)="item.editarUnidad = false"
                >
                  <option value="">Seleccione unidad</option>
                  <option *ngFor="let unidad of unidades" [value]="unidad">
                    {{ unidad }}
                  </option>
                </select>
              </ng-container>

              <ng-template #verUnidad>
                <p (click)="item.editarUnidad = true" class="mb-0" style="cursor: pointer;">
                  {{ unidadTexto(item.unidad ?? '') }}
                </p>
              </ng-template>

            </td>
            <!-- Cantidad -->
            <td class="input-cell">
              <input
                type="number"
                [(ngModel)]="item.cantidad"
                class="full-width-input text-center"
                placeholder="Cantidad"
                (ngModelChange)="item.cantidad = item.cantidad ?? 0"
              />
            </td>

            <td class="input-cell">
                <p class="fw-bold text-success mb-0">
                  {{ item.precio_unitario | number: '1.2-2' }}
                </p>
              
            </td>

            <td class="input-cell">
              <p>{{ formatearNumero(getValorAgregado(item)) }}</p>
            </td>

            <td class="input-cell">
              <p>{{ formatearNumero(SumaPrecioUnitarioActividad(item)) }}</p>
            </td>

            <td class="input-cell col-md-3">
              <textarea
                readonly
                [ngModel]="item.precio_literal"
                class="form-control"
                placeholder="Literal"
                rows="2"
                style="resize: none; white-space: pre-line"
              ></textarea>
            </td>

            <td>
              {{
                formatearNumero(MultiplicacionPrecioUnitarioActividadPORcantidad(item))
              }}
            </td>

            <!-- 游녢 columna de acciones (solo en pantalla) -->
            <td class="no-export">
              <div class="d-flex justify-content-center gap-2">
                <ng-container *ngIf="item.esNuevo; else accionesExistente">
                  <button
                    class="btn btn-success btn-sm"
                    (click)="registrarItem(i)"
                  >
                    <i class="bi bi-check2-circle me-1"></i> Registrar
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="eliminarItem(i)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="enviarAEcuacion(item)"
                  >
                    <i class="bi bi-send"></i> Ver Ecuaciones
                  </button>
                </ng-container>

                <ng-template #accionesExistente>
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="actualizarItem(i)"
                  >
                    <i class="bi bi-pencil"></i> Actualizar
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="eliminarItem(i)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="enviarAEcuacion(item)"
                  >
                    <i class="bi bi-send"></i> Precio Unitario
                  </button>
                  <button
                    class="btn btn-success btn-sm"
                    (click)="enviarTotalGastosGenerales(item)"
                  >
                    <i class="bi bi-receipt"></i> Precio Factura
                  </button>
                </ng-template>
              </div>
            </td>
          </tr>

          <!-- 游녢 fila vac칤a tambi칠n no se exporta -->
          <tr *ngIf="items.length === 0" class="no-export">
            <td colspan="10" class="text-center text-muted py-4">
              No hay 칤tems registrados.
            </td>
          </tr>
        </tbody>

        <tfoot class="table-light">
          <tr>
            <td colspan="8" class="text-end fw-bold">
              TOTAL PRECIO FACTURA (Numeral)
            </td>
            <td class="fw-bold">{{ formatearNumero(total) }}</td>
            <td class="no-export"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  <p class="text-center text-muted mt-3 fw-bold">
    Son: {{ totalLiteral }}
  </p>
</div>
<app-confirmacion
  *ngIf="mostrarConfirmacion"
  [mensaje]="mensajeConfirmacion"
  (aceptar)="manejarAceptar()"
  (cancelar)="manejarCancelar()"
></app-confirmacion>
<app-ok *ngIf="mensajeExito" [mensaje]="mensajeExito" (close)="manejarOk()"></app-ok>
<app-error *ngIf="mensajeError" [mensaje]="mensajeError" (close)="manejarError()"></app-error>