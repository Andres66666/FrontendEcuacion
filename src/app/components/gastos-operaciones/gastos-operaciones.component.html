
  <div id="contentToExport">
    <h2 class="mb-4 text-primary text-center text-uppercase" >
      PRESUPUESTO POR ACTIVIDAD Y GENERAL DEL PROYECTO
    </h2>
    <!-- Formulario de porcentajes -->
    <div class="rounded shadow-sm">
      <div class="row">
        <!-- üìå Columna Izquierda: Tabla de Par√°metros -->
        <div class="col-md-6 no-export">
          <button 
            class="btn btn-outline-primary mb-2 w-100"
            (click)="mostrarParametros = !mostrarParametros"
          >
            {{ mostrarParametros ? 'Ocultar Par√°metros' : 'Mostrar Par√°metros' }}
          </button>

          <div *ngIf="mostrarParametros" class="no-export">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th scope="col" class="text-center">PAR√ÅMETROS</th>
                  <th scope="col" class="text-center">EN PORCENTAJE (%)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="align-middle">CARGAS SOCIALES</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="carga_social" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IVA TASA EFECTIVA</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="iva_efectiva" /></td>
                </tr>
                <tr>
                  <td class="align-middle">HERRAMIENTAS</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="herramientas" /></td>
                </tr>
                <tr>
                  <td class="align-middle">GASTOS GENERALES</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="gastos_generales" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IVA TASA NOMINAL</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="iva_tasa_nominal" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IT TASA NOMINAL</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="it" /></td>
                </tr>
                <tr>
                  <td class="align-middle">IUE - IMPUESTO A LAS UTILIDADES DE LAS EMPRESAS</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="iue" /></td>
                </tr>
                <tr>
                  <td class="align-middle">GANANCIA</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="ganancia" /></td>
                </tr>
                <tr>
                  <td class="align-middle">A - COSTO DE VENTA</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="a_costo_venta" /></td>
                </tr>
                <tr>
                  <td class="align-middle">B - MARGEN DE UTILIDAD</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="b_margen_utilidad" /></td>
                </tr>
                <tr>
                  <td class="align-middle">PORCENTAJE GLOBAL</td>
                  <td><input type="number" class="form-control text-center" [(ngModel)]="porcentaje_global_100" /></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- üìå Columna Derecha: Selecci√≥n Proyecto + Botones -->
        <div class="col-md-6 d-flex flex-column justify-content-end mb-3">
          <div class="mb-3 text-center no-export" style="position: relative;">
            <input
              class="form-control text-center"
              placeholder="Nombre del Proyecto"
              [(ngModel)]="nombreProyecto"
              (focus)="focusInput()"
              (input)="filtrarProyectos()"
            />

            <!-- Dropdown simulado con ancho reducido -->
            <ul
              *ngIf="mostrarLista"
              class="list-group position-absolute text-start"
              style="z-index: 1000; max-height: 200px; overflow-y: auto; width: 50%; left: 0;"
            >
              <li
                class="list-group-item list-group-item-action"
                *ngFor="let proyecto of proyectosFiltrados"
                (click)="seleccionarProyecto(proyecto)"
              >
                {{ proyecto.NombreProyecto }}
              </li>
            </ul>
          </div>

          <div class="d-flex flex-wrap gap-2 justify-content-end no-export">
            <!-- Botones -->
            <button
              class="btn btn-success"
              *ngIf="identificadorGeneral === 0"
              (click)="crearIdentificadorSiEsNecesario()"
              title="Registrar Proyecto"
            >
             <i class="bi bi-plus-circle fs-5"></i>
            </button>

            <button
              class="btn btn-danger"
              *ngIf="identificadorGeneral !== 0"
              (click)="eliminarProyecto()"
              title="Eliminar Proyecto"
            >
              <i class="bi bi-trash fs-5"></i>
            </button>


            <button
              class="btn btn-primary"
              *ngIf="identificadorGeneral !== 0"
              (click)="actualizarProyecto()"
              title="Actualizar Proyecto"
            >
              <i class="bi bi-arrow-repeat fs-5"></i>
            </button>

            <button
              class="btn btn-success"
              [disabled]="identificadorGeneral === 0"
              (click)="agregarItem()"
              title="Agregar √çtem Gastos Operaci√≥n"
            >
              <i class="bi bi-plus-square fs-5"></i>
            </button>
            <button
              class="btn btn-secondary d-flex align-items-center justify-content-center"
              title="Configuraciones"
            >
              <i class="bi bi-gear fs-4"></i>
            </button>


            <button
              class="btn btn-danger d-flex align-items-center justify-content-center"
              (click)="exportPDF()"
              title="Exportar a PDF"
            >
              <i class="bi bi-file-earmark-pdf fs-4"></i>
            </button>


            <button
              class="btn btn-primary d-flex align-items-center justify-content-center"
              (click)="exportWORD()"
              title="Exportar a Word"
            >
              <i class="bi bi-file-earmark-word fs-4"></i>
            </button>
          </div>

        </div>
      </div>
    </div>

    <!-- Tabla de Gastos de Operaci√≥n -->
    <div
      class="table-responsive border rounded shadow-sm"
      style="max-height: 500px; overflow-y: auto"
    >
      <table class="table table-bordered table-hover align-middle text-center mb-0">
        <thead class="table-primary">
          <tr>
            <th>Item</th>
            <th>Descripci√≥n</th>
            <th>Unidad.</th>
            <th>Cantidad</th>
            <th>Gastos De Operacion</th>
            <th>Valor Agregado</th>
            <th>Precio Unitario Actividad</th>
            <th>Precio Unitario Literal</th>
            <th>Precio Factura Parcial</th>
            <th class="no-export">Acciones</th> <!-- üëà no se exporta -->
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let item of items; let i = index">
            <td>{{ i + 1 }}</td>
            <td class="input-cell">
              <input
                [(ngModel)]="item.descripcion"
                class="full-width-input"
                placeholder="Descripci√≥n"
              />
            </td>
            <td>
            <!-- Si el item es nuevo o est√° en modo editar, mostramos el select -->
            <ng-container *ngIf="item.esNuevo || item.editarUnidad; else verUnidad">
              <select [(ngModel)]="item.unidad" class="form-select" (blur)="item.editarUnidad = false">
                <option value="" selected>Seleccione unidad</option>
                <option value="BLS">BLS ‚Äì BOLSA</option>
                <option value="BRR">BRR ‚Äì BARRA</option>
                <option value="CD">CD ‚Äì CUADRILLA DIA.</option>
                <option value="CJA">CJA ‚Äì CAJA</option>
                <option value="CNX">CNX ‚Äì CONEXION</option>
                <option value="EVE">EVE ‚Äì EVENTO</option>
                <option value="GL">GL ‚Äì GALON</option>
                <option value="GLB">GLB ‚Äì GLOBAL</option>
                <option value="HA">HA ‚Äì HECTAREA</option>
                <option value="HDR">HDR ‚Äì HOMBRES POR DIA</option>
                <option value="HH">HH ‚Äì HOMBRES HORA</option>
                <option value="HR">HR ‚Äì HORA</option>
                <option value="HRS">HRS ‚Äì HORAS</option>
                <option value="HY.">HY. ‚Äì HOYO</option>
                <option value="JGO">JGO ‚Äì JUEGO</option>
                <option value="KG">KG ‚Äì KILOGRAMOS</option>
                <option value="KIT">KIT ‚Äì KITS</option>
                <option value="KM">KM ‚Äì KILOMETRO</option>
                <option value="KMB">KMB ‚Äì KILOMETROS BERMA</option>
                <option value="LT">LT ‚Äì LITROS</option>
                <option value="M">M ‚Äì METRO</option>
                <option value="M2">M2 ‚Äì METROS CUADRADOS</option>
                <option value="M3">M3 ‚Äì METROS CUBICOS</option>
                <option value="M3K">M3K ‚Äì METRO CUBICO POR KILOMETRO</option>
                <option value="MED">MED ‚Äì MEDICION</option>
                <option value="MK">MK ‚Äì MOTO KILOMETRO</option>
                <option value="ML">ML ‚Äì METROS LINEALES</option>
                <option value="P2">P2 ‚Äì PIE CUADRADO</option>
                <option value="PAR">PAR ‚Äì UN PAR</option>
                <option value="PER">PER ‚Äì PERSONAS</option>
                <option value="PIE">PIE ‚Äì PIE LINEAL</option>
                <option value="PLA">PLA ‚Äì PLANTIN</option>
                <option value="PTO">PTO ‚Äì PUNTO</option>
                <option value="PZA">PZA ‚Äì PIEZA</option>
                <option value="RLL">RLL ‚Äì ROLLO</option>
                <option value="TLL">TLL ‚Äì TALLER</option>
                <option value="TN">TN ‚Äì TONELADA</option>
                <option value="TON">TON ‚Äì TONELADAS</option>
                <option value="UND">UND ‚Äì UNIDAD</option>
              </select>
            </ng-container>

            <!-- Modo solo lectura -->
            <ng-template #verUnidad>
              <p (click)="item.editarUnidad = true" class="mb-0" style="cursor: pointer;">
                {{ item.unidad ? unidadTexto(item.unidad) : 'Seleccione unidad' }}
              </p>
            </ng-template>
          </td>


            <td class="input-cell">
              <input
                type="number"
                [(ngModel)]="item.cantidad"
                class="full-width-input text-center"
                placeholder="Cantidad"
                (ngModelChange)="item.cantidad = item.cantidad ?? 0"
              />
            </td>

            <td class="input-cell">
                <p class="fw-bold text-success mb-0">
                  {{ item.precio_unitario | number:'1.2-2' }}
                </p>
              
            </td>

            <td class="input-cell">
              <p>{{ getValorAgregado(item) | number : '1.2-2' }}</p>
            </td>

            <td class="input-cell">
              <p>{{ SumaPrecioUnitarioActividad(item) | number : '1.2-2' }}</p>
            </td>

            <td class="input-cell col-md-3">
              <textarea
                readonly
                [ngModel]="item.precio_literal"
                class="form-control"
                placeholder="Literal"
                rows="2"
                style="resize: none; white-space: pre-line"
              ></textarea>
            </td>

            <td>
              {{
                MultiplicacionPrecioUnitarioActividadPORcantidad(item)
                  | number : '1.2-2'
              }}
            </td>

            <!-- üëá columna de acciones (solo en pantalla) -->
            <td class="no-export">
              <div class="d-flex justify-content-center gap-2">
                <ng-container *ngIf="item.esNuevo; else accionesExistente">
                  <button
                    class="btn btn-success btn-sm"
                    (click)="registrarItem(i)"
                  >
                    <i class="bi bi-check2-circle me-1"></i> Registrar
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="eliminarItem(i)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="enviarAEcuacion(item)"
                  >
                    <i class="bi bi-send"></i> Ver Ecuaciones
                  </button>
                </ng-container>

                <ng-template #accionesExistente>
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="actualizarItem(i)"
                  >
                    <i class="bi bi-pencil"></i> Actualizar
                  </button>
                  <button class="btn btn-danger btn-sm" (click)="eliminarItem(i)">
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                  <button
                    class="btn btn-warning btn-sm"
                    (click)="enviarAEcuacion(item)"
                  >
                    <i class="bi bi-send"></i> Precio Unitario
                  </button>
                  <button
                    class="btn btn-success btn-sm"
                    (click)="enviarTotalGastosGenerales(item)"
                  >
                    <i class="bi bi-receipt"></i> Precio Factura
                  </button>
                </ng-template>
              </div>
            </td>
          </tr>

          <!-- üëá fila vac√≠a tambi√©n no se exporta -->
          <tr *ngIf="items.length === 0" class="no-export">
            <td colspan="10" class="text-center text-muted py-4">
              No hay √≠tems registrados.
            </td>
          </tr>
        </tbody>

        <tfoot class="table-light">
          <tr>
            <td colspan="8" class="text-end fw-bold">
              TOTAL PRECIO FACTURA (Numeral)
            </td>
            <td class="fw-bold">{{ total | number : '1.2-2' }}</td>
            <td class="no-export"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  <p class="text-center text-muted mt-3 fw-bold">
    Son: {{ totalLiteral }}
  </p>
</div>
