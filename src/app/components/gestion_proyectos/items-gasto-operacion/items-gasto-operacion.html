<!-- items-gasto-operacion.html (con botón de actualizar siempre visible para pruebas) -->
<!-- UNA SOLA TABLA -->
<div class="card-body mt-5">
  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-success" (click)="abrirModalRegistrar()">
      <i class="bi bi-plus-circle"></i> Agregar Ítem
    </button>
  </div>

  <!-- UNA SOLA TABLA -->
  <table class="table table-sm table-bordered">
    <thead class="table-light">
      <tr class="text-center">
        <th>ÍTEM</th>
        <th>DESCRIPCIÓN</th>
        <th>UNIDAD</th>
        <th>CANTIDAD</th>
        <th>PRECIO UNITARIO</th>
        <th>COSTO PARCIAL</th>
        <th>GASTOS DE OPERACIÓN PARCIAL</th>
        <th>VALOR AGREGADO</th>
        <th>ACCIONES</th>
      </tr>
    </thead>

    <tbody>
      <!-- UN SOLO NG-FOR DE MÓDULOS -->
      <ng-container *ngFor="let m of modulosConGastos()">
        <!-- FILA CABECERA DEL MÓDULO -->
        <tr class="table-secondary fw-bold">
          <td colspan="9">
            {{ m.codigo }} - {{ m.nombre }} ({{ getGastosPorModulo(m.id).length
            }} ÍTEMS)
            <button
              class="btn btn-outline-success btn-sm ms-1 float-end"
              title="Reporte Financiero del Módulo"
              (click)="enviarReporteFinancieroModulo(m.id)"
            >
              <i class="bi bi-ui-checks-grid"></i>
            </button>
          </td>
        </tr>

        <!-- FILAS DE ÍTEMS -->
        <tr *ngFor="let g of getGastosPorModulo(m.id); let i = index">
          <td>{{ getIndiceGlobal(m.id, i) }}</td>
          <td>{{ g.descripcion }}</td>
          <td>{{ g.unidad }}</td>
          <td>{{ formatearNumero(g.cantidad) }}</td>

          <td>{{ formatearNumero(getTotalFinal(g)) }}</td>

          <!-- Solo de lectura -->
          <td>{{ formatearNumero(g.costo_parcial) }}</td>
          <td>
            {{ formatearNumero(getTotalItemGastosOperacionesParcial(g)) }}
          </td>
          <td>{{ formatearNumero(getValorAgregado(g)) }}</td>
          <td class="text-end">
            <button
              *ngIf="hasChanges(g)"
              class="btn btn-outline-success btn-sm"
              title="Actualizar Precios en BD"
              (click)="actualizarDatosEnBD(g)"
            >
              <i class="bi bi-arrow-clockwise"></i>
            </button>

            <button
              class="btn btn-outline-primary btn-sm ms-1"
              (click)="abrirEditar(g)"
              title="Editar Ítem"
            >
              <i class="bi bi-pencil"></i>
            </button>
            <button
              class="btn btn-outline-danger btn-sm ms-1"
              (click)="eliminarGasto(g.id!)"
              title="Eliminar Ítem"
            >
              <i class="bi bi-trash"></i>
            </button>
            <button
              class="btn btn-outline-dark btn-sm ms-1"
              title="Registro de materiales, equipo y mano de obra"
              (click)="enviarAEcuacion(g)"
            >
              <i class="bi bi-tools"></i>
            </button>

            <button
              class="btn btn-outline-success btn-sm ms-1"
              title="Reporte Financiero del Ítem"
              (click)="enviarReporteFinanciero(g)"
            >
              <i class="bi bi-list-ul"></i>
            </button>
          </td>
        </tr>
      </ng-container>
      <tr class="table-secondary fw-bold">
        <td colspan="5" class="text-end">TOTAL PROYECTO:</td>
        <td>{{ formatearNumero(getTotalCostoParcial()) }}</td>
        <td>{{ formatearNumero(getTotalProyectoGastosOperacionParcial()) }}</td>
        <td>{{ formatearNumero(getTotalProyectoValorAgregado()) }}</td>
        <td class="text-end">
          <button
            class="btn btn-outline-success btn-sm ms-1"
            title="Reporte Financiero del Proyecto"
            (click)="enviarGastoOperacionParcialValorAgregado()"
          >
            <i class="bi bi-receipt"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- MODAL (sin cambios) -->
<div
  class="modal fade show d-block"
  *ngIf="mostrarModal"
  style="background: rgba(0, 0, 0, 0.5)"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ modoEdicion ? 'Editar Ítem' : 'Nuevo Ítem' }}
        </h5>
        <button class="btn-close" (click)="mostrarModal=false"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Módulo</label>
            <select class="form-select" [(ngModel)]="itemForm.modulo">
              <option value="" disabled>Seleccione módulo</option>
              <option *ngFor="let m of modulos" [value]="m.id">
                {{ m.codigo }} - {{ m.nombre }}
              </option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Descripción</label>
            <input
              class="form-control"
              [(ngModel)]="itemForm.descripcion"
              (input)="toUpper('descripcion')"
            />
          </div>
          <div class="col-md-6 position-relative">
            <label class="form-label">Unidad</label>
            <input
              class="form-control"
              [(ngModel)]="itemForm.unidad"
              (focus)="mostrarUnidad()"
              (input)="filtrarUnidad(); toUpper('unidad')"
              (blur)="ocultarUnidad()"
            />

            <ul
              *ngIf="opcionesUnidad.length"
              class="list-group position-absolute w-100"
              style="z-index: 1000; max-height: 200px; overflow-y: auto"
            >
              <li
                class="list-group-item list-group-item-action"
                *ngFor="let u of opcionesUnidad"
                (click)="seleccionarUnidad(u)"
              >
                {{ u }}
              </li>
            </ul>
          </div>

          <div class="col-md-6">
            <label class="form-label">Cantidad</label>
            <input
              type="number"
              class="form-control"
              [(ngModel)]="itemForm.cantidad"
              (input)="calcularCosto()"
            />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="mostrarModal=false">
          Cancelar
        </button>
        <button class="btn btn-success" (click)="guardarDesdeModal()">
          {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>
</div>
