<div class="container py-4">
  <div class="card shadow rounded-4 mx-auto" style="max-width: 700px">
    <div class="card-body">
      <h3 class="card-title mb-4 text-center text-primary">Editar Usuario</h3>

      <form [formGroup]="form" (ngSubmit)="actualizarUsuario()">
        <div class="row g-3">
          <!-- Nombre -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Nombre</label>
            <input
              type="text"
              class="form-control"
              formControlName="nombre"
              placeholder="Ingrese sus nombres"
              (input)="form.get('nombre')?.markAsTouched()"
              [class.is-invalid]="
                form.get('nombre')?.invalid && form.get('nombre')?.touched
              "
            />
            <div class="invalid-feedback" *ngIf="form.get('nombre')?.touched">
              <div *ngIf="form.get('nombre')?.hasError('required')">
                El nombre es obligatorio
              </div>
              <div *ngIf="form.get('nombre')?.hasError('minlength')">
                Mínimo 3 caracteres
              </div>
              <div *ngIf="form.get('nombre')?.hasError('maxlength')">
                Máximo 20 caracteres
              </div>
              <div *ngIf="form.get('nombre')?.hasError('soloTexto')">
                Solo se permiten letras y espacios
              </div>
            </div>
          </div>

          <!-- Apellido -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Apellido</label>
            <input
              type="text"
              class="form-control"
              formControlName="apellido"
              placeholder="Ingrese sus apellidos"
              (input)="form.get('apellido')?.markAsTouched()"
              [class.is-invalid]="
                form.get('apellido')?.invalid && form.get('apellido')?.touched
              "
            />
            <div class="invalid-feedback" *ngIf="form.get('apellido')?.touched">
              <div *ngIf="form.get('apellido')?.hasError('required')">
                El apellido es obligatorio
              </div>
              <div *ngIf="form.get('apellido')?.hasError('minlength')">
                Mínimo 3 caracteres
              </div>
              <div *ngIf="form.get('apellido')?.hasError('maxlength')">
                Máximo 20 caracteres
              </div>
              <div *ngIf="form.get('apellido')?.hasError('soloTexto')">
                Solo se permiten letras y espacios
              </div>
            </div>
          </div>

          <!-- Correo -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Correo</label>
            <input
              type="email"
              class="form-control"
              formControlName="correo"
              placeholder="ejemplo@gmail.com"
              (input)="form.get('correo')?.markAsTouched()"
              [class.is-invalid]="
                form.get('correo')?.invalid && form.get('correo')?.touched
              "
            />
            <div class="invalid-feedback" *ngIf="form.get('correo')?.touched">
              <div *ngIf="form.get('correo')?.hasError('required')">
                El correo es obligatorio
              </div>
              <div *ngIf="form.get('correo')?.hasError('invalidEmail')">
                Solo se permiten correos de Gmail, Hotmail u Outlook
              </div>
              <div *ngIf="form.get('correo')?.hasError('emailExists')">
                Este correo ya está registrado
              </div>
              <div *ngIf="form.get('correo')?.hasError('userFetchError')">
                No se pudo verificar el correo en la base de datos
              </div>
            </div>
          </div>

          <!-- Teléfono -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Teléfono</label>
            <input
              type="text"
              class="form-control"
              formControlName="telefono"
              placeholder="Ej: 71234567"
              inputmode="numeric"
              maxlength="8"
              (input)="form.get('telefono')?.markAsTouched()"
              [class.is-invalid]="
                form.get('telefono')?.invalid && form.get('telefono')?.touched
              "
            />
            <div class="invalid-feedback" *ngIf="form.get('telefono')?.touched">
              <div *ngIf="form.get('telefono')?.hasError('required')">
                El teléfono es obligatorio
              </div>
              <div *ngIf="form.get('telefono')?.hasError('invalidPhone')">
                Debe comenzar con 6 o 7 y tener 8 dígitos
              </div>
              <div *ngIf="form.get('telefono')?.hasError('soloNumeros')">
                Solo se permiten números
              </div>
              <div *ngIf="form.get('telefono')?.hasError('phoneExists')">
                Este número ya está registrado
              </div>
              <div *ngIf="form.get('telefono')?.hasError('userFetchError')">
                No se pudo verificar el teléfono en la base de datos
              </div>
            </div>
          </div>

          <!-- CI -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Cédula de Identidad</label>
            <input
              type="text"
              class="form-control"
              formControlName="ci"
              placeholder="Ej: 12345678"
              maxlength="8"
              (input)="form.get('ci')?.markAsTouched()"
              [class.is-invalid]="
                form.get('ci')?.invalid && form.get('ci')?.touched
              "
            />
            <div class="invalid-feedback" *ngIf="form.get('ci')?.touched">
              <div *ngIf="form.get('ci')?.hasError('required')">
                El CI es obligatorio
              </div>
              <div *ngIf="form.get('ci')?.hasError('invalidCI')">
                El CI debe tener entre 7 y 8 dígitos
              </div>
              <div *ngIf="form.get('ci')?.hasError('soloNumeros')">
                Solo se permiten números
              </div>
              <div *ngIf="form.get('ci')?.hasError('ciExists')">
                Este CI ya está registrado
              </div>
              <div *ngIf="form.get('ci')?.hasError('userFetchError')">
                No se pudo verificar el CI en la base de datos
              </div>
            </div>
          </div>

          <!-- Fecha de nacimiento -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Fecha de Nacimiento</label>
            <input
              type="date"
              class="form-control"
              formControlName="fecha_nacimiento"
              (input)="form.get('fecha_nacimiento')?.markAsTouched()"
              [class.is-invalid]="
                form.get('fecha_nacimiento')?.invalid &&
                form.get('fecha_nacimiento')?.touched
              "
            />
            <div
              class="invalid-feedback"
              *ngIf="form.get('fecha_nacimiento')?.touched"
            >
              <div *ngIf="form.get('fecha_nacimiento')?.hasError('required')">
                La fecha de nacimiento es obligatoria
              </div>
              <div *ngIf="form.get('fecha_nacimiento')?.hasError('underage')">
                Debe tener al menos 18 años
              </div>
            </div>
          </div>

          <!-- Contraseña -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Contraseña (opcional)</label>
            <div class="input-group">
              <input
                [type]="showPassword ? 'text' : 'password'"
                class="form-control rounded-start-3"
                formControlName="password"
                placeholder="Ingrese nueva contraseña si desea cambiarla"
                [class.is-invalid]="
                  form.get('password')?.invalid && form.get('password')?.touched
                "
              />
              <button
                type="button"
                class="btn rounded-end-3"
                [ngClass]="showPassword ? 'btn-success' : 'btn-danger'"
                (click)="togglePasswordVisibility()"
              >
                <i
                  [ngClass]="showPassword ? 'bi bi-eye' : 'bi bi-eye-slash'"
                ></i>
              </button>
            </div>

            <div class="invalid-feedback" *ngIf="form.get('password')?.touched">
              <div *ngIf="form.get('password')?.hasError('invalidPassword')">
                La contraseña debe tener al menos 8 caracteres, con mayúscula,
                minúscula, número y símbolo.
              </div>
            </div>
          </div>

          <!-- Rol -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">Rol (opcional)</label>
            <select class="form-select" formControlName="rol">
              <option value="">Sin rol asignado</option>
              <option *ngFor="let r of roles" [value]="r.id">
                {{ r.nombre }}
              </option>
            </select>
          </div>

          <!-- Imagen -->
          <div class="col-md-6 mb-4">
            <label class="form-label fw-bold mb-3">Imagen (opcional)</label>
            <label
              for="imagenInput"
              class="custom-file-upload-bs d-flex flex-column align-items-center justify-content-center p-4 border border-primary rounded-3 text-primary bg-light shadow-sm w-100"
              style="min-height: 180px; cursor: pointer"
            >
              <i class="bi bi-cloud-arrow-up-fill fs-2 mb-2"></i>
              <span class="fw-semibold text-center"
                >Selecciona o arrastra una imagen (PNG/JPEG)</span
              >
              <span class="text-muted small mt-1">Haz clic para buscar</span>
              <input
                type="file"
                id="imagenInput"
                (change)="onFileChange($event)"
                accept="image/png, image/jpeg"
                class="d-none"
              />
            </label>

            <div class="invalid-feedback d-block mt-2" *ngIf="errorMensaje">
              <i class="bi bi-exclamation-triangle-fill me-1"></i>
              {{ errorMensaje }}
            </div>
          </div>

          <!-- Vista previa de imagen -->
          <div class="col-md-6 mb-4">
            <label class="form-label fw-bold mb-3">Imagen Seleccionada</label>
            <div
              *ngIf="imagenPreview"
              class="d-flex flex-column align-items-center justify-content-center p-3 border border-success rounded-3 bg-success-subtle position-relative"
              style="min-height: 180px; min-width: 180px"
            >
              <img
                [src]="imagenPreview"
                alt="Vista Previa"
                class="img-fluid rounded shadow-sm mb-3"
                style="max-width: 120px; max-height: 120px; object-fit: contain"
              />
              <button
                type="button"
                class="btn btn-outline-danger btn-sm"
                (click)="quitarImagen()"
              >
                <i class="bi bi-trash me-1"></i> Quitar Imagen
              </button>
              <i
                class="bi bi-check-circle-fill text-success position-absolute top-0 end-0 translate-middle fs-4 bg-white rounded-circle p-1 shadow-sm"
              ></i>
            </div>
            <div
              *ngIf="!imagenPreview"
              class="d-flex flex-column align-items-center justify-content-center p-3 border border-secondary rounded-3 bg-light"
              style="min-height: 180px; min-width: 180px"
            >
              <i class="bi bi-image text-muted fs-1 mb-2"></i>
              <span class="text-muted small text-center"
                >No hay imagen seleccionada</span
              >
            </div>
          </div>
        </div>

        <!-- Botones -->
        <div
          class="d-flex flex-column flex-md-row justify-content-between gap-2 mt-4"
        >
          <button
            type="button"
            class="btn btn-outline-secondary w-100"
            (click)="volver()"
          >
            <i class="bi bi-arrow-left-circle me-2"></i> Volver
          </button>
          <button
            type="button"
            class="btn btn-warning w-100"
            (click)="restablecerFormulario()"
          >
            <i class="bi bi-eraser me-2"></i> Limpiar
          </button>

          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-save me-2"></i> Actualizar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Éxito -->
<app-ok
  *ngIf="mensajeExito"
  [mensaje]="mensajeExito"
  (close)="manejarOk()"
></app-ok>

<!-- Modal de Error -->
<app-error
  *ngIf="mensajeError"
  [mensaje]="mensajeError"
  (close)="manejarError()"
></app-error>
