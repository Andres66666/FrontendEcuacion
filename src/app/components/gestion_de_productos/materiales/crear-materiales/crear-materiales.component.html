<form [formGroup]="formulario">
  <div class="card border-primary mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>1. Materiales</h5>
    </div>

    <div class="card-body" formArrayName="materiales">
      <table class="table table-bordered table-hover align-middle mb-3">
        <thead class="table-light text-center">
          <tr>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>P. Unitario</th>
            <th>Precio parcial</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let mat of materiales.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- Descripción -->
            <td>
              <input
                type="text"
                class="form-control"
                formControlName="descripcion"
                placeholder="Ej. Cemento"
              />
              <div
                *ngIf="mat.get('descripcion')?.errors?.['required']"
                class="text-danger small"
              >
                Campo requerido.
              </div>
            </td>

            <!-- Unidad -->
            <td>
              <select
                class="form-select"
                formControlName="unidad"
                (change)="onUnidadChange(mat)"
              >
                <option value="">Seleccione unidad</option>
                <option value="kg">kg – kilogramo</option>
                <option value="g">g – gramo</option>
                <option value="m">m – metro</option>
                <option value="m²">m² – metro cuadrado</option>
                <option value="m³">m³ – metro cúbico</option>
                <option value="l">l – litro</option>
                <option value="h">h – hora</option>
                <option value="ud">ud – unidad</option>
                <option value="mm">mm – milímetro</option>
                <option value="cm">cm – centímetro</option>
              </select>

              <div
                *ngIf="mat.get('unidad')?.errors?.['required']"
                class="text-danger small"
              >
                Campo requerido.
              </div>
            </td>

            <!-- Cantidad -->
            <td>
              <input
                type="number"
                class="form-control"
                formControlName="cantidad"
                min="0"
                (keydown)="blockE($event)"
                (change)="onCantidadChange(mat)"
              />
              <div
                *ngIf="mat.get('cantidad')?.errors?.['required']"
                class="text-danger small"
              >
                Campo requerido.
              </div>
              <div
                *ngIf="
                  mat.get('cantidad')?.hasError('min') &&
                  mat.get('cantidad')?.touched
                "
                class="text-danger small"
              >
                No puede ser menor o igual a 0.
              </div>
            </td>

            <!-- Precio Unitario -->
            <td>
              <input
                type="number"
                class="form-control"
                formControlName="precioUnitario"
                min="0"
                (keydown)="blockE($event)"
                (change)="onPrecioUniChange(mat)"
              />
              <div
                *ngIf="mat.get('precioUnitario')?.errors?.['required']"
                class="text-danger small"
              >
                Campo requerido.
              </div>
              <div
                *ngIf="
                  mat.get('precioUnitario')?.hasError('min') &&
                  mat.get('precioUnitario')?.touched
                "
                class="text-danger small"
              >
                No puede ser menor o igual a 0.
              </div>
            </td>

            <!-- Precio Parcial (readonly) -->
            <td>
              <input
                type="number"
                class="form-control bg-white"
                [value]="mat.get('precioParcial')?.value"
                readonly
              />
            </td>

            <!-- Acción -->
            <td class="text-center">
              <button
                type="button"
                class="btn btn-outline-danger btn-sm"
                (click)="eliminarMaterial(i)"
              >
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <button
        type="button"
        class="btn btn-outline-primary mt-2"
        (click)="agregarMaterial()"
      >
        <i class="bi bi-plus-circle me-1"></i> Añadir Material
      </button>
    </div>

    <div class="card-footer">
      <table class="table table-bordered table-hover mb-0">
        <tbody>
          <tr class="table-primary fw-bold">
            <td>Total Materiales</td>
            <td class="text-end">{{ totalMateriales | number : "1.2-2" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</form>
