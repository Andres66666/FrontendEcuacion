
  <h2 class="mb-4 text-primary text-center text-uppercase">
    Gastos de Operaci√≥n
  </h2>
  <div class="mb-3 text-center">
    <ng-container *ngIf="identificadorGeneral === 0; else proyectoFijo">
      <input
        [(ngModel)]="nombreProyecto"
        class="form-control text-center"
        placeholder="Nombre del Proyecto (√∫nico)"
      />
    </ng-container>

    <ng-template #proyectoFijo>
      <p class="text-start text-muted mb-2">
        {{ nombreProyecto }}
      </p>
    </ng-template>
    <P>IDENTIFICADOR : {{ identificadorGeneral }}</P>
    
  </div>
  <!-- === SELECT Y BOT√ìN ALINEADOS EN UNA SOLA FILA === -->
  <div class="row mb-3 align-items-center justify-content-end">
    <!-- Columna para el selector -->
    <div class="col-md-6 col-lg-4 mb-2 mb-md-0">
      <select
        id="selectorProyecto"
        class="form-select text-center"
        [(ngModel)]="proyectoSeleccionado"
        (change)="onProyectoSeleccionado()"
      >
        <option class="text-start" [ngValue]="null" disabled selected>
          -- Elige un proyecto --
        </option>
        <option
          class="text-start"
          *ngFor="let proyecto of listaProyectos"
          [ngValue]="proyecto"
        >
          {{ proyecto.NombreProyecto }}
        </option>
      </select>
    </div>

    <!-- Columna para el bot√≥n -->
    <div class="col-auto">
      <button
        class="btn btn-success w-100"
        (click)="crearIdentificadorSiEsNecesario()"
      >
        Agregar √çtem
      </button>
    </div>
  </div>

  <div
    class="table-responsive border rounded shadow-sm"
    style="max-height: 500px; overflow-y: auto"
  >
    <table class="table table-bordered table-hover align-middle text-center mb-0">

      <thead class="table-primary">
        <tr>
          <th>Item</th>
          <th>Descripci√≥n</th>
          <th>Unidad.</th>
          <th>Cantidad</th>
          <th>Precio Unitario</th>
          <th>Precio Unitario Literal</th>
          <th>Costo Parcial</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of items; let i = index">
          <td>{{ i + 1 }}</td>
          <td class="input-cell">
            <input
              [(ngModel)]="item.descripcion"
              class="full-width-input"
              placeholder="Descripci√≥n"
            />
          </td>
          <td>
            <select [(ngModel)]="item.unidad" class="form-select">
              <option selected value="">Seleccione unidad</option>
              <option value="kg">kg ‚Äì kilogramo</option>
              <option value="g">g ‚Äì gramo</option>
              <option value="m">m ‚Äì metro</option>
              <option value="m¬≤">m¬≤ ‚Äì metro cuadrado</option>
              <option value="m¬≥">m¬≥ ‚Äì metro c√∫bico</option>
              <option value="l">l ‚Äì litro</option>
              <option value="h">h ‚Äì hora</option>
              <option value="ud">ud ‚Äì unidad</option>
              <option value="mm">mm ‚Äì mil√≠metro</option>
              <option value="cm">cm ‚Äì cent√≠metro</option>
            </select>
          </td>
          <td class="input-cell">
            <input
              type="number"
              (keydown)="blockE($event)"
              [(ngModel)]="item.cantidad"
              class="full-width-input text-end"
              placeholder="Cantidad"
              (ngModelChange)="item.cantidad = item.cantidad ?? 0"
            />
          </td>
          <td class="input-cell">
            <input
              type="number"
              step="0.01"
              (keydown)="blockE($event)"
              [(ngModel)]="item.precio_unitario"
              (change)="onPrecioUnitarioChange(i)"
              class="full-width-input text-end"
              placeholder="Precio Unitario"
              (ngModelChange)="item.precio_unitario = item.precio_unitario ?? 0"
            />
            <div *ngIf="formatoInvalido" class="text-danger small">
              Formato no v√°lido. M√°ximo 2 decimales.
            </div>
          </td>
          <td class="input-cell col-md-3">
            <textarea
              readonly
              [(ngModel)]="item.precio_literal"
              class="form-control"
              placeholder="Literal"
              rows="2"
              style="resize: none"
            ></textarea>
          </td>
          <td>
            {{
              (item.cantidad ?? 0) * (item.precio_unitario ?? 0)
                | number : "1.2-2"
            }}
          </td>
          <td>
            <div class="d-flex justify-content-center gap-2">
              <ng-container *ngIf="item.esNuevo; else accionesExistente">
                <button
                  class="btn btn-success btn-sm"
                  (click)="registrarItem(i)"
                >
                  <i class="bi bi-check2-circle me-1"></i> Registrar
                </button>
                <button class="btn btn-danger btn-sm" (click)="eliminarItem(i)">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
                <!-- üöÄ Nuevo bot√≥n para ir a la vista de ecuaciones -->
                <button
                  class="btn btn-warning btn-sm"
                  (click)="enviarAEcuacion(item)"
                >
                  <i class="bi bi-send"></i> Ver Ecuaciones
                </button>
              </ng-container>

              <ng-template #accionesExistente>
                <button
                  class="btn btn-primary btn-sm"
                  (click)="actualizarItem(i)"
                >
                  <i class="bi bi-pencil"></i> Actualizar
                </button>
                <button class="btn btn-danger btn-sm" (click)="eliminarItem(i)">
                  <i class="bi bi-trash"></i> Eliminar
                </button>
                <!-- üöÄ Nuevo bot√≥n para ir a la vista de ecuaciones -->
                <button
                  class="btn btn-warning btn-sm"
                  (click)="enviarAEcuacion(item)"
                >
                  <i class="bi bi-send"></i> Ver Ecuaciones
                </button>
              </ng-template>
            </div>
          </td>
        </tr>

        <tr *ngIf="items.length === 0">
          <td colspan="8" class="text-center text-muted py-4">
            No hay √≠tems registrados.
          </td>
        </tr>
      </tbody>

      <tfoot class="table-light">
        <tr>
          <td colspan="6" class="text-end fw-bold">
            TOTAL GASTOS DE OPERACI√ìN
          </td>
          <td class="fw-bold">{{ total | number : "1.2-2" }}</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <p class="text-center text-muted mt-3">
    Son: {{ total | currency : "BOB" : "symbol" : "1.2-2" }}
  </p>

  <div class="d-flex justify-content-end mt-4">
    <button class="btn btn-primary" (click)="guardarItems()">
      <i class="bi bi-save me-1"></i> Guardar todos los √≠tems
    </button>
  </div>

