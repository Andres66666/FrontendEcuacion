<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">Panel de Bloqueo de Atacantes</h3>
    </div>
    <div>
      <div class="btn-group me-2" role="group">
        <button
          *ngFor="let tipo of tiposAtaque"
          type="button"
          class="btn btn-outline-primary d-flex align-items-center"
          [class.active]="selectedTipo === tipo"
          (click)="filterByTipo(tipo)"
        >
          <img
            [src]="tipoIconos[tipo]"
            alt="{{ tipo }}"
            style="width: 50px; height: 50px; margin-right: 6px"
          />
          {{ tipo }}
        </button>
      </div>

      <button class="btn btn-outline-secondary" (click)="showAll()">
        Ver todos
      </button>
    </div>
  </div>

  <div class="row">
    <!-- Lista atacantes -->
    <div class="col-lg-6 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <ul class="list-group">
            <li
              *ngFor="let a of filteredAtacantes"
              class="list-group-item d-flex justify-content-between align-items-start"
              (click)="seleccionarAtacante(a)"
              [class.active]="a === selectedAtacante"
              style="cursor: pointer"
            >
              <div class="ms-2 me-auto">
                <div class="fw-bold">{{ a.ip }}</div>
                <div class="small text-muted">
                  Tipos: {{ a.tipos.join(", ") }} ‚Ä¢ User Agent:
                  {{ a.user_agent }}
                </div>
                <div class="small text-muted">
                  Fecha: {{ a.fecha | date : "MM/dd/yy, h:mm a" }}
                </div>
              </div>
              <div class="text-end">
                <div class="mt-2">
                  <button
                    class="btn btn-sm"
                    [ngClass]="a.bloqueado ? 'btn-success' : 'btn-danger'"
                    (click)="toggleBloqueo(a); $event.stopPropagation()"
                  >
                    {{ a.bloqueado ? "Desbloquear" : "Bloquear" }}
                  </button>
                </div>
              </div>
            </li>
            <li
              *ngIf="filteredAtacantes.length === 0"
              class="list-group-item text-center text-muted"
            >
              No hay registros
            </li>
          </ul>
        </div>
        <div class="card-footer text-muted small">
          Simulaci√≥n UI ‚Äî botones activos
        </div>
      </div>
    </div>

    <!-- Detalles atacante -->
    <div class="col-lg-6 mb-3" *ngIf="selectedAtacante">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="card-title">Detalles ‚Äî {{ selectedAtacante.ip }}</h5>
          <dl class="row">
            <dt class="col-sm-4">Tipos de ataque</dt>
            <dd class="col-sm-8">{{ selectedAtacante.tipos.join(", ") }}</dd>

            <dt class="col-sm-4">User Agent</dt>
            <dd class="col-sm-8">{{ selectedAtacante.user_agent }}</dd>

            <dt class="col-sm-4">Fecha</dt>
            <dd class="col-sm-8">
              {{ selectedAtacante.fecha | date : "MM/dd/yy, h:mm a" }}
            </dd>

            <dt class="col-sm-4">Estado</dt>
            <dd class="col-sm-8">
              {{ selectedAtacante.bloqueado ? "Bloqueado" : "Activo" }}
            </dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>

<div>
  <div class="row align-items-center mb-4">
    <div class="col-md-auto me-auto mb-3 mb-md-0">
      <h3 class="mb-0">Panel de Auditor√≠a</h3>
      <small class="text-muted">Evoluci√≥n de ataques detectados</small>
    </div>

    <div class="col-6 col-md-3 col-lg-2 ms-auto">
      <label for="rangeSelect" class="form-label mb-1">Rango:</label>
      <select
        id="rangeSelect"
        class="form-select"
        [(ngModel)]="selectedRange"
        (change)="onRangeChange()"
      >
        <option value="dia">Por d√≠a</option>
        <option value="mes">Por mes</option>
        <option value="anio">Por a√±o</option>
      </select>
    </div>

    <div class="col-6 col-md-3 col-lg-3">
      <label for="tipoSelect" class="form-label mb-1">Tipo de ataque:</label>
      <select
        id="tipoSelect"
        class="form-select"
        [(ngModel)]="selectedTipo"
        (change)="filterByTipo(selectedTipo)"
      >
        <option value="">Todos</option>
        <option *ngFor="let tipo of tiposAtaque" [value]="tipo">
          {{ tipo }}
        </option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-8 mb-3">
      <div class="card h-100">
        <div class="card-body">
          <h5>Gr√°fico de L√≠neas - Evoluci√≥n ataques</h5>
          <div id="myChart" style="height: 400px; width: 100%"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-body">
          <h5>Resumen: Distribuci√≥n por Tipo</h5>
          <p class="mb-0" [innerHTML]="tipoResumen"></p>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <h5>Resumen: Bloqueados vs Activos</h5>
          <p class="mb-0">{{ estadoResumen }}</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div>
  <h3 class="mb-3">üìã Registro de Eventos de Auditor√≠a</h3>

  <div *ngIf="cargando" class="text-center text-muted">Cargando datos...</div>

  <div *ngIf="!cargando && eventos.length === 0" class="alert alert-warning">
    No hay eventos de auditor√≠a registrados.
  </div>

  <div *ngIf="!cargando && eventos.length > 0">
    <table class="table table-bordered table-striped table-hover align-middle">
      <thead class="table-dark text-center">
        <tr>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Descripci√≥n</th>
          <th>Severidad</th>
          <th>IP Publica</th>
          <th>IP Privada</th>

          <th>Navegador</th>
          <th>Sistema Operativo</th>
          <th>Ruta</th>
          <th>M√©todo HTTP</th>
          <th>Rol Usuario</th>
          <th>Ubicaci√≥n</th>
          <th>Usuario ID</th>
          <th>Bloqueado</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let e of eventos">
          <td>{{ e.fecha | date : "short" }}</td>
          <td>{{ e.tipo }}</td>
          <td>{{ e.descripcion || "-" }}</td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                'bg-success': e.severidad === 'BAJO',
                'bg-warning text-dark': e.severidad === 'MEDIO',
                'bg-orange': e.severidad === 'ALTO',
                'bg-danger': e.severidad === 'CRITICO'
              }"
            >
              {{ e.severidad }}
            </span>
          </td>
          <td>{{ e.ip_cliente_publica || "-" }}</td>
          <td>{{ e.ip_cliente_privada || "-" }}</td>
          <td>{{ e.navegador || "-" }}</td>
          <td>{{ e.sistema_operativo || "-" }}</td>
          <td>{{ e.ruta || "-" }}</td>
          <td>{{ e.metodo_http || "-" }}</td>
          <td>{{ e.rol_usuario || "-" }}</td>
          <td>{{ e.ubicacion || "-" }}</td>
          <td>{{ e.usuario || "An√≥nimo" }}</td>
          <td>
            <span
              class="badge"
              [ngClass]="{
                'bg-success': !e.bloqueado,
                'bg-danger': e.bloqueado
              }"
            >
              {{ e.bloqueado ? "S√≠" : "No" }}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<script>
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;

      // Guardar en localStorage o enviar al backend
      localStorage.setItem("user_coords", `${lat},${lon}`);

      // Ejemplo: enviar coordenadas junto con la siguiente petici√≥n
      fetch("/api/evento", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-User-Lat": lat,
          "X-User-Lon": lon,
        },
        body: JSON.stringify({ mensaje: "Evento desde cliente" }),
      });
    },
    (err) => {
      console.warn("No se pudo obtener ubicaci√≥n:", err.message);
    }
  );
</script>
