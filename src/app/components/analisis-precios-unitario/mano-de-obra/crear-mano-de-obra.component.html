<form [formGroup]="formulario">
  <div class="card">
    <div class="card-header bg-success bg-opacity-25">
      <h5><i class="bi bi-person-workspace me-1"></i>2. Mano de Obra</h5>
    </div>

    <div class="card-body" formArrayName="manoObra">
      <div class="d-flex justify-content-end no-export">
        <button
          type="button"
          class="btn btn-outline-success mb-3"
          (click)="agregarManoDeObra()"
        >
          + Agregar mano de obra
        </button>
      </div>

      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Precio Total</th>
            <th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr
            *ngFor="let mano of manoObra.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- DESCRIPCIÓN -->
            <td class="position-relative">
              <input
                type="text"
                class="form-control"
                formControlName="descripcion"
                (focus)="mostrarDescripcion(i)"
                (input)="
                  filtrarDescripcion(i); convertirAMayusculas(i, 'descripcion')
                "
                (blur)="ocultarDescripcion(i)"
              />
              <ul
                *ngIf="opcionesDescripcion[i]?.length"
                class="list-group position-absolute w-100"
                style="z-index: 1000; max-height: 200px; overflow-y: auto"
              >
                <li
                  class="list-group-item list-group-item-action"
                  *ngFor="let opt of opcionesDescripcion[i]"
                  (click)="seleccionarDescripcion(i, opt)"
                >
                  {{ opt.descripcion }}
                </li>
              </ul>
            </td>

            <!-- UNIDAD -->
            <td class="position-relative">
              <input
                type="text"
                class="form-control"
                formControlName="unidad"
                (focus)="mostrarUnidad(i)"
                (input)="filtrarUnidad(i); convertirAMayusculas(i, 'unidad')"
                (blur)="ocultarUnidad(i)"
              />
              <ul
                *ngIf="opcionesUnidad[i]?.length"
                class="list-group position-absolute w-100"
                style="z-index: 1000; max-height: 200px; overflow-y: auto"
              >
                <li
                  class="list-group-item list-group-item-action"
                  *ngFor="let u of opcionesUnidad[i]"
                  (click)="seleccionarUnidad(i, u)"
                >
                  {{ u }}
                </li>
              </ul>
            </td>

            <!-- CANTIDAD -->
            <td>
              <input
                type="number"
                class="form-control"
                formControlName="cantidad"
                (change)="actualizarPrecioParcial(mano)"
              />
            </td>
            <!-- PRECIO UNITARIO -->
            <td>
              <input
                type="number"
                class="form-control"
                formControlName="precio_unitario"
                (change)="onPrecioUniChange(mano, i)"
              />
            </td>

            <!-- PRECIO total -->
            <td class="text-end">
              {{ formatearNumero(calcularPrecioParcial(mano)) }}
            </td>

            <!-- ACCIONES -->
            <td class="text-center">
              <button
                *ngIf="!mano.get('id')?.value"
                type="button"
                class="btn btn-outline-success btn-sm me-1"
                (click)="guardar(i)"
                title="Guardar mano de obra"
              >
                <i class="bi bi-check-lg"></i>
              </button>

              <button
                *ngIf="mano.get('id')?.value && mano.dirty"
                type="button"
                class="btn btn-outline-primary btn-sm me-1"
                (click)="guardar(i)"
                title="Guardar cambios"
              >
                <i class="bi bi-arrow-clockwise"></i>
              </button>

              <button
                type="button"
                class="btn btn-outline-danger btn-sm"
                (click)="eliminar(i)"
                title="Eliminar mano de obra"
              >
                <i class="bi bi-trash3"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- TOTALES -->
    <div class="card-footer">
      <table class="table table-bordered mb-0">
        <tbody>
          <tr>
            <td>Subtotal Mano de Obra</td>
            <td class="text-end">{{ formatearNumero(subtotalManoObra) }}</td>
          </tr>
          <tr>
            <td>Cargas Sociales ({{ formatearNumero(carga_social) }} %)</td>
            <td class="text-end">{{ formatearNumero(cargasManoObra) }}</td>
          </tr>
          <tr>
            <td>IVA ({{ formatearNumero(iva_efectiva) }} %)</td>
            <td class="text-end">{{ formatearNumero(ivaManoObra) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="card-footer text-end fw-bold">
      TOTAL MANO DE OBRA: {{ formatearNumero(totalManoObra) }}
    </div>
  </div>
</form>
