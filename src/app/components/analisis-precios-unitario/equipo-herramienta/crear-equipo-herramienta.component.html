<!-- ========== EQUIPOS Y HERRAMIENTAS ========== -->
<form [formGroup]="formulario" *ngIf="formulario">
  <div class="card border-warning mb-4">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">
        <i class="bi bi-tools me-2"></i>3. Equipos y Herramientas
      </h5>
    </div>
    <div class="card-body" formArrayName="equipos">
      <div class="d-flex justify-content-end no-export">
        <button
          type="button"
          class="btn btn-outline-warning mt-2 mb-3"
          (click)="agregarEquipo()"
        >
          <i class="bi bi-plus-circle me-1"></i> Añadir Equipo
        </button>
      </div>

      <table class="table table-bordered table-hover align-middle mb-3">
        <thead class="table-light text-center">
          <tr>
            <th>Descripción</th>
            <th>Unidad</th>
            <th>Cantidad</th>
            <th>P. Unitario</th>
            <th>Precio parcial</th>
            <th class="no-export">Acción</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let eq of equipos.controls; let i = index"
            [formGroupName]="i"
          >
            <!-- Descripción (replicado exactamente: autocomplete con lista y auto-precio) -->
            <td>
              <div class="position-relative">
                <input
                  type="text"
                  class="form-control input-descripcion"
                  placeholder="Ej. Excavadora"
                  [formControl]="getDescripcionControl(i)"
                  (input)="filtrarDescripciones(i, $event)"
                  (focus)="mostrarDescripcionesFila(i)"
                  (blur)="guardarDescripcionPersonalizada(i, $event)"
                />

                <ul
                  *ngIf="
                    descripcionesFiltradas[i]?.length &&
                    mostrarListaDescripcion[i]
                  "
                  class="list-group position-absolute w-100 descripcion-list"
                  style="z-index: 1000; max-height: 150px; overflow-y: auto"
                >
                  <li
                    *ngFor="let d of descripcionesFiltradas[i]"
                    class="list-group-item list-group-item-action p-1"
                    (mousedown)="seleccionarDescripcion(i, d)"
                    style="cursor: pointer"
                  >
                    {{ d }}
                  </li>
                </ul>

                <!-- Corregido: usa 'eq' en lugar de 'equipo' -->
                <div
                  *ngIf="eq.get('descripcion')?.errors?.['required']"
                  class="text-danger small"
                >
                  Campo requerido.
                </div>
              </div>
            </td>

            <!-- Unidad (replicado exactamente: input editable con autocomplete, no select) -->
            <td>
              <div class="position-relative">
                <input
                  type="text"
                  class="form-control form-control-sm input-unidad"
                  placeholder="Seleccione o escriba una unidad"
                  [formControl]="getUnidadControl(i)"
                  (input)="filtrarUnidades(i, $event)"
                  (focus)="mostrarUnidadesFila(i)"
                  (blur)="guardarUnidadPersonalizada(i, $event)"
                />

                <ul
                  *ngIf="unidadesFiltradas[i]?.length && mostrarLista[i]"
                  class="list-group position-absolute w-100 unidad-list"
                  style="z-index: 1000; max-height: 150px; overflow-y: auto"
                >
                  <li
                    *ngFor="let u of unidadesFiltradas[i]"
                    class="list-group-item list-group-item-action p-1"
                    (mousedown)="seleccionarUnidad(i, u)"
                    style="cursor: pointer"
                  >
                    {{ u }}
                  </li>
                </ul>

                <!-- Corregido: usa 'eq' en lugar de 'equipo' -->
                <div
                  *ngIf="eq.get('unidad')?.errors?.['required']"
                  class="text-danger small"
                >
                  Campo requerido.
                </div>
              </div>
            </td>

            <!-- Cantidad (replicado: pasa el control 'eq'; ya estaba correcto) -->
            <td>
              <input
                type="number"
                class="form-control"
                formControlName="cantidad"
                (keydown)="blockE($event)"
                (change)="onCantidadChange(eq)"
              />
              <!-- Opcional: agrega error si quieres consistencia -->
              <div
                *ngIf="eq.get('cantidad')?.errors?.['required']"
                class="text-danger small"
              >
                Campo requerido.
              </div>
            </td>

            <!-- Precio Unitario (replicado: pasa 'eq' e 'i'; corregido para 2 argumentos) -->
            <td>
              <input
                type="number"
                class="form-control"
                formControlName="precio_unitario"
                (keydown)="blockE($event)"
                (change)="onPrecioUniChange(eq, i)"
              />
              <!-- Corregido: usa 'eq' en lugar de 'equipo' -->
              <div
                *ngIf="eq.get('precio_unitario')?.errors?.['required']"
                class="text-danger small"
              >
                Campo requerido.
              </div>
            </td>

            <!-- Precio Parcial (readonly) (replicado exactamente; ya usaba 'eq') -->
            <td>
              <input
                type="number"
                class="form-control bg-white"
                [value]="eq.get('total')?.value"
                readonly
              />
            </td>

            <!-- Acción (replicado: usa 'eq' en lugar de 'mat'; ya estaba correcto) -->
            <td class="text-center no-export">
              <div class="d-flex justify-content-center gap-2">
                <ng-container
                  *ngIf="eq.get('esNuevo')?.value; else accionesExistente"
                >
                  <button
                    class="btn btn-success btn-sm"
                    (click)="registrarItem(i)"
                  >
                    <i class="bi bi-check2-circle me-1"></i> Registrar
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    (click)="eliminarItem(i)"
                  >
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </ng-container>
                <ng-template #accionesExistente>
                  <button
                    class="btn btn-primary btn-sm"
                    (click)="actualizarItem(i)"
                  >
                    <i class="bi bi-pencil"></i> Actualizar
                  </button>
                  <button
                    class="btn btn-danger btn-sm"
                    (click)="eliminarItem(i)"
                  >
                    <i class="bi bi-trash"></i> Eliminar
                  </button>
                </ng-template>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card-footer">
      <table class="table table-bordered table-hover mb-0">
        <tbody>
          <tr>
            <td>Subtotal Equipo Herramienta</td>
            <td class="text-end">{{ formatearNumero(subtotalEquipos) }}</td>
          </tr>
          <tr>
            <td>
              <p>
                Herramientas ({{ formatearNumero(herramientas) }} %) * Total
                Mano de Obra: {{ formatearNumero(totalManoObra) }}
              </p>
            </td>
            <td class="text-end">
              {{ formatearNumero(herramientasPorcentaje) }}
            </td>
          </tr>
          <tr class="table-warning fw-bold">
            <td>Total Equipos y Herramientas</td>
            <td class="text-end">{{ totalEquiposFormateado }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</form>

<app-confirmacion
  *ngIf="mostrarConfirmacion"
  [mensaje]="mensajeConfirmacion"
  (aceptar)="manejarAceptar()"
  (cancelar)="manejarCancelar()"
></app-confirmacion>

<app-ok
  *ngIf="mensajeExito"
  [mensaje]="mensajeExito"
  (close)="manejarOk()"
></app-ok>
<app-error
  *ngIf="mensajeError"
  [mensaje]="mensajeError"
  (close)="manejarError()"
></app-error>
