<section class="layout">
  <!-- Navbar (header) -->
  <nav class="navbar navbar-expand-md header navbar-dark bg-white">
    <div class="container-fluid mx-2">
      <button class="toggle-button btn me-2" (click)="toggleSidebar()">
        <img
          [src]="isSidebarOpen ? imagenCerrar : imagenAbrir"
          alt="toggle sidebar"
          style="width: 24px; height: 24px"
        />
      </button>

      <div class="ms-auto d-flex align-items-center gap-2">
        <div class="dropdown d-flex align-items-center">
          <!-- ← NUEVO: Botón de Notificaciones (antes del dropdown del usuario) -->
          <div class="me-3 position-relative">
            <button
              class="btn btn-outline-primary position-relative"
              type="button"
              (click)="toggleNotificaciones()"
              title="Notificaciones de usuarios bloqueados"
            >
              <i class="bi bi-bell"></i>
              <span
                *ngIf="notificaciones.length > 0"
                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              >
                {{ notificaciones.length }}
                <span class="visually-hidden">Usuarios bloqueados</span>
              </span>
            </button>

            <!-- ← NUEVO: Dropdown de Notificaciones -->
            <div
              *ngIf="mostrarNotificaciones"
              class="dropdown-menu dropdown-menu-end show mt-2"
              style="max-height: 300px; overflow-y: auto; width: 300px"
            >
              <h6 class="dropdown-header">
                Usuarios Desactivados ({{ notificaciones.length }})
              </h6>
              <div
                *ngIf="notificaciones.length === 0"
                class="dropdown-item text-center text-muted"
              >
                No hay usuarios bloqueados.
              </div>
              <a
                *ngFor="let notif of notificaciones"
                class="dropdown-item"
                href="javascript:void(0)"
                (click)="verNotificacion(notif)"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ notif.nombre }}</strong
                    ><br />
                    <small class="text-muted">{{ notif.correo }}</small>
                  </div>
                  <small class="text-muted">{{
                    notif.fechaBloqueo | date : "short"
                  }}</small>
                </div>
              </a>
              <div class="dropdown-divider"></div>
              <a
                class="dropdown-item text-center"
                (click)="recargarNotificaciones(); $event.preventDefault()"
              >
                <i class="bi bi-arrow-clockwise me-1"></i>Recargar
              </a>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2 me-3">
            <img
              src="https://cdn-icons-gif.flaticon.com/10967/10967596.gif"
              alt="Reloj de arena"
              class="img-fluid"
              style="width: 40px; height: 40px"
            />
            <span class="fw-bold">Día: {{ diasTranscurridos }}</span>
          </div>

          <!-- ... (resto del dropdown del usuario igual, sin cambios) -->
          <button
            class="btn btn-secondary dropdown-toggle d-flex align-items-center"
            type="button"
            id="dropdownMenuButton"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <div class="me-2">
              <img
                *ngIf="imagenUrl"
                [src]="imagenUrl"
                alt="Foto de usuario"
                class="rounded-circle img-fluid"
                style="width: 40px; height: 40px"
              />
            </div>
            {{ userName }}
          </button>

          <ul
            class="dropdown-menu dropdown-menu-end"
            aria-labelledby="dropdownMenuButton"
          >
            <li>
              <div
                class="dropdown-item d-flex align-items-center"
                (click)="verPerfil()"
              >
                <img
                  src="https://cdn-icons-png.flaticon.com/128/14778/14778312.png"
                  alt="cerrarSesion"
                  class="img-fluid"
                  style="width: 30px; height: 30px"
                />
                <span>Ver Perfil</span>
              </div>
            </li>
            <li>
              <div
                class="dropdown-item text-danger d-flex align-items-center"
                (click)="onSelectChange('cerrarSesion')"
              >
                <img
                  src="https://cdn-icons-png.flaticon.com/128/2550/2550435.png"
                  alt="cerrarSesion"
                  class="img-fluid"
                  style="width: 30px; height: 30px"
                />
                <span> Cerrar Sesión</span>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar (leftSide) -->
  <aside
    class="leftSide aside-dark bg-white p-3"
    [class.sidebar-open]="isSidebarOpen"
    [class.sidebar-closed]="!isSidebarOpen"
  >
    <div class="mb-3">
      <div class="d-flex justify-content-center align-items-center">
        <img
          src="https://res.cloudinary.com/dexggkhkd/image/upload/v1750767599/logoMallaPNG_g2ta8p.png"
          alt=""
          style="max-width: 200px"
        />
      </div>

      <hr class="text-dark" />
      <p class="text-dark mb-0">Nombre: {{ userName }}</p>
      <p class="text-dark">Rol: {{ userRole }}</p>

      <hr class="text-dark" />
    </div>

    <ul class="list-group">
      <!-- Gestión de Usuarios -->
      <li
        class="d-flex align-items-center p-2 rounded"
        *ngIf="puedeVer('GestionDeUsuarios')"
        (click)="toggleSection('GestióndeUsuarios')"
      >
        <div style="width: 40px; flex-shrink: 0">
          <img
            src="https://cdn-icons-png.flaticon.com/128/1402/1402118.png"
            style="max-width: 100%"
          />
        </div>
        <div class="flex-grow-1 text-start ms-2">
          <span class="text-dark">Gestión de Usuarios</span>
        </div>
        <div>
          <i
            class="bi text-dark"
            [ngClass]="
              isActive('GestionDeUsuarios')
                ? 'bi-chevron-down'
                : 'bi-chevron-right'
            "
          ></i>
        </div>
      </li>

      <ul class="list-group ps-3 mt-2" *ngIf="isActive('GestióndeUsuarios')">
        <li
          class="d-flex align-items-center p-2 rounded"
          *ngIf="puedeVer('ListarRoles')"
        >
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/8964/8964949.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/listar-rol"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Rol</a
            >
          </div>
        </li>
        <li
          class="d-flex align-items-center p-2 rounded"
          *ngIf="puedeVer('ListarPermisos')"
        >
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/3315/3315568.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/listar-permiso"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Permiso</a
            >
          </div>
        </li>
        <li
          class="d-flex align-items-center p-2 rounded"
          *ngIf="puedeVer('ListarUsuarios')"
        >
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/3660/3660732.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/listar-usuario"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Usuarios</a
            >
          </div>
        </li>
        <li
          class="d-flex align-items-center p-2 rounded"
          *ngIf="puedeVer('ListarUsuarioRol')"
        >
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/10307/10307344.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/listar-usuario-rol"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Usuario Rol</a
            >
          </div>
        </li>
        <li
          class="d-flex align-items-center p-2 rounded"
          *ngIf="puedeVer('ListarRolPermiso')"
        >
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/18841/18841862.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/listar-rol-permiso"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Rol Permiso</a
            >
          </div>
        </li>
      </ul>

      <!-- Operaciones -->
      <li
        class="d-flex align-items-center p-2 rounded mt-2"
        *ngIf="puedeVer('Operaciones')"
        (click)="toggleSection('Operaciones')"
      >
        <div style="width: 40px; flex-shrink: 0">
          <img
            src="https://cdn-icons-png.flaticon.com/128/3919/3919704.png"
            style="max-width: 100%"
          />
        </div>
        <div class="flex-grow-1 text-start ms-2">
          <span class="text-dark">Operaciones</span>
        </div>
        <div>
          <i
            class="bi text-dark"
            [ngClass]="
              isActive('Operaciones') ? 'bi-chevron-down' : 'bi-chevron-right'
            "
          ></i>
        </div>
      </li>

      <ul class="list-group ps-3 mt-2" *ngIf="isActive('Operaciones')">
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/1575/1575408.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/gastos-operaciones"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Gastos Operaciones</a
            >
          </div>
        </li>
      </ul>
      <!-- Reportes -->
      <li
        class="d-flex align-items-center p-2 rounded mt-2"
        *ngIf="puedeVer('Reportes')"
        (click)="toggleSection('Reportes')"
      >
        <div style="width: 40px; flex-shrink: 0">
          <img
            src="https://cdn-icons-png.flaticon.com/128/9422/9422941.png"
            style="max-width: 100%"
          />
        </div>
        <div class="flex-grow-1 text-start ms-2">
          <span class="text-dark">Reportes</span>
        </div>
        <div>
          <i
            class="bi text-dark"
            [ngClass]="
              isActive('Reportes') ? 'bi-chevron-down' : 'bi-chevron-right'
            "
          ></i>
        </div>
      </li>

      <ul class="list-group ps-3 mt-2" *ngIf="isActive('Reportes')">
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/10961/10961459.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/sql"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte SQL Inyección</a
            >
          </div>
        </li>
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/13502/13502242.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/xss"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte XSS</a
            >
          </div>
        </li>
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/4440/4440880.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/csrf"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte CSRF</a
            >
          </div>
        </li>
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/6653/6653409.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/ddos"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte DoS</a
            >
          </div>
        </li>
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/2842/2842036.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/keylogger"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte Keylogger</a
            >
          </div>
        </li>
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/4307/4307952.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/auditoria"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte Auditoría</a
            >
          </div>
        </li>
        <li class="d-flex align-items-center p-2 rounded">
          <div style="width: 40px; flex-shrink: 0">
            <img
              src="https://cdn-icons-png.flaticon.com/128/14668/14668039.png"
              style="max-width: 100%"
            />
          </div>
          <div class="flex-grow-1 text-start ms-2">
            <a
              routerLink="/panel-control/ia"
              class="text-dark text-decoration-none"
              (click)="closeSidebarOnMobile()"
              >Reporte IA General</a
            >
          </div>
        </li>
        <!-- Más items de reportes siguiendo la misma estructura -->
      </ul>
    </ul>
  </aside>
  <!-- Overlay para móvil -->
  <div
    class="overlay"
    *ngIf="windowWidth < 768"
    [class.overlay-visible]="isSidebarOpen"
    (click)="toggleSidebar()"
  ></div>
  <!-- Contenido principal (body) -->
  <main
    class="main-content"
    [class.content-shifted]="isSidebarOpen && windowWidth >= 768"
  >
    <div class="p-2">
      <router-outlet></router-outlet>
    </div>
  </main>
</section>
<app-confirmacion
  *ngIf="mostrarConfirmacion"
  [mensaje]="mensajeConfirmacion"
  (aceptar)="manejarAceptar()"
  (cancelar)="manejarCancelar()"
></app-confirmacion>
